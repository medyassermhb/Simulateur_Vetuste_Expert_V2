<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BETCAM | Simulateur Vétusté Expert V21</title>
    
    <!-- Bibliothèques -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .input-field {
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
        }
        .input-field:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        /* Custom Dropdown Styling */
        #custom_suggestions {
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid #cbd5e1;
        }
        
        .suggestion-item {
            padding: 12px 14px 12px 24px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            background-color: white; 
            color: #334155;
        }
        .suggestion-item:active, .suggestion-item:hover {
            background-color: #eff6ff !important;
            color: #4338ca;
        }
        
        .suggestion-header {
            padding: 8px 12px;
            background-color: #f1f5f9;
            color: #64748b;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid #e2e8f0;
        }

        .category-badge {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 2px 8px;
            border-radius: 999px;
            white-space: nowrap;
        }

        /* Radio Group Styling */
        .source-radio:checked + label {
            background-color: #eff6ff; /* blue-50 */
            border-color: #3b82f6; /* blue-500 */
            color: #1d4ed8; /* blue-700 */
            box-shadow: 0 0 0 1px #3b82f6;
        }
        .source-radio:checked + label .check-icon {
            opacity: 1;
            transform: scale(1);
        }

        /* Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #d97706; /* amber-600 */
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #fcd34d; /* amber-300 */
            border-radius: 2px;
        }
        
        /* Restore Notification */
        #restore_notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: none;
        }

        /* Info Box Animation */
        .info-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* PDF specific hidden area */
        #pdf-template { display: none; }
        
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="text-slate-800 p-3 md:p-8 min-h-screen relative">

    <!-- RESTORE NOTIFICATION -->
    <div id="restore_notification" class="w-[90%] md:w-auto bg-slate-900 text-white p-4 rounded-xl shadow-2xl flex items-center justify-between gap-4">
        <div class="text-sm">
            <p class="font-bold">Dossier non sauvegardé détecté</p>
            <p class="text-xs text-slate-400">Voulez-vous le restaurer ?</p>
        </div>
        <div class="flex gap-2">
            <button onclick="dismissRestore()" class="px-3 py-1.5 text-xs text-slate-400 hover:text-white">Non</button>
            <button onclick="performRestore()" class="px-3 py-1.5 bg-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-500">Oui, Restaurer</button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto space-y-4 md:space-y-6">
        
        <!-- HEADER -->
        <div class="flex flex-col md:flex-row justify-between items-center bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-slate-100 no-print">
            <div class="flex items-center gap-4 w-full md:w-auto">
                <div class="w-10 h-10 md:w-12 md:h-12 bg-indigo-600 rounded-xl flex items-center justify-center text-white text-lg md:text-xl shadow-lg shadow-indigo-200 shrink-0">
                    <i class="fa-solid fa-calculator"></i>
                </div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold text-slate-900">Simulateur Vétusté</h1>
                    <p class="text-[10px] md:text-xs text-slate-500 uppercase tracking-wider font-medium">Cabinet BETCAM • V21 (PDF Classement)</p>
                </div>
            </div>
            <div class="mt-4 md:mt-0 flex gap-2 w-full md:w-auto">
                <button onclick="resetApp()" class="flex-1 md:flex-none px-3 py-2 text-slate-500 hover:text-slate-700 text-xs md:text-sm font-medium transition-colors bg-slate-50 rounded-lg md:bg-transparent">
                    <i class="fa-solid fa-rotate-right mr-1"></i>Reset
                </button>
                <button onclick="generatePDF()" class="flex-1 md:flex-none px-4 py-2 bg-slate-900 text-white rounded-lg text-xs md:text-sm font-medium hover:bg-slate-800 transition-all shadow-md">
                    <i class="fa-solid fa-file-export mr-1"></i>PDF
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 md:gap-6">
            
            <!-- LEFT COLUMN: CONFIGURATION -->
            <div class="lg:col-span-4 space-y-4 md:space-y-6 no-print">
                
                <!-- 1. VEHICLE CONTEXT -->
                <div class="glass-panel p-4 md:p-6 rounded-2xl">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 md:mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-car"></i> Véhicule & Dates
                    </h2>
                    
                    <div class="space-y-3 md:space-y-4">
                        <!-- DOSSIER & IMMAT -->
                        <div class="grid grid-cols-2 gap-2 md:gap-3">
                            <div>
                                <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">N° Dossier</label>
                                <input type="text" id="ref_dossier" placeholder="Ex: 24-001" class="w-full p-2 md:p-2.5 rounded-lg bg-white input-field text-sm font-medium" oninput="saveData()">
                            </div>
                            <div>
                                <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">Immatriculation</label>
                                <input type="text" id="ref_immat" placeholder="Ex: 12345-A-1" class="w-full p-2 md:p-2.5 rounded-lg bg-white input-field text-sm font-medium" oninput="saveData()">
                            </div>
                        </div>

                        <!-- DATES -->
                        <div class="grid grid-cols-2 gap-2 md:gap-3">
                            <div>
                                <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">M.E.C</label>
                                <input type="date" id="date_mec" class="w-full p-2 md:p-2.5 rounded-lg bg-white input-field text-xs md:text-sm" onchange="calcAge(); saveData()">
                            </div>
                            <div>
                                <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">Sinistre</label>
                                <input type="date" id="date_sinistre" value="<?php echo date('Y-m-d'); ?>" class="w-full p-2 md:p-2.5 rounded-lg bg-white input-field text-xs md:text-sm" onchange="calcAge(); saveData()">
                            </div>
                        </div>

                        <!-- Computed Age Display -->
                        <div class="bg-indigo-50 border border-indigo-100 p-2 md:p-3 rounded-lg flex items-center justify-between">
                            <span class="text-xs font-medium text-indigo-800">Année entamée</span>
                            <span id="display_age" class="text-sm font-bold text-indigo-600">--</span>
                            <input type="hidden" id="calculated_year" value="1">
                        </div>

                        <div>
                            <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">Catégorie (Tarif)</label>
                            <select id="cat_vehicule" class="w-full p-2 md:p-2.5 rounded-lg bg-white input-field text-xs md:text-sm font-medium" onchange="recalcAll(); saveData()">
                                <option value="A">Tourisme / Particulier</option>
                                <option value="B">Utilitaire / Poids Lourds</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 2. ADD PART FORM -->
                <div class="glass-panel p-4 md:p-6 rounded-2xl border-t-4 border-indigo-500 relative z-30">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 md:mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-plus-circle"></i> Ajouter une pièce
                    </h2>
                    
                    <div class="space-y-3 md:space-y-4">
                        <!-- Famille Select -->
                        <div class="relative z-10">
                            <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">1. Famille / Catégorie</label>
                            <select id="part_type" class="w-full p-2 md:p-2.5 rounded-lg bg-white input-field text-sm font-medium" onchange="resetAndFilterSuggestions()">
                                <option value="CARROSSERIE">Carrosserie (Structure, Vitrage, Eclairage)</option>
                                <option value="MECANIQUE">Mécanique / Électrique</option>
                                <option value="USURE">Pièces d'Usure (Entretien)</option>
                            </select>
                        </div>

                        <!-- Custom Searchable Dropdown - HIGH Z-INDEX -->
                        <div class="relative z-50">
                            <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">2. Libellé Pièce (Recherche)</label>
                            <div class="relative">
                                <!-- PADDING LEFT FORCED TO 40px to clear the icon -->
                                <input type="text" id="part_name" 
                                       placeholder="Saisir ou choisir..." 
                                       class="w-full p-2.5 rounded-lg input-field text-sm font-semibold text-slate-800" 
                                       style="background-color: #ffffff !important; opacity: 1 !important; -webkit-appearance: none; padding-left: 40px !important; padding-right: 40px !important;"
                                       autocomplete="off"
                                       autocorrect="off"
                                       autocapitalize="off"
                                       spellcheck="false"
                                       onfocus="showSuggestions()"
                                       oninput="filterSuggestions()">
                                
                                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
                                
                                <button onclick="clearInput()" class="absolute right-2 top-1/2 transform -translate-y-1/2 p-2 text-slate-300 hover:text-rose-500 transition-colors z-20">
                                    <i class="fa-solid fa-times-circle"></i>
                                </button>
                            </div>
                            
                            <!-- CUSTOM UL LIST (Z-INDEX 100 to stay on top) -->
                            <ul id="custom_suggestions" class="hidden absolute left-0 right-0 top-full mt-1 bg-white rounded-lg shadow-2xl w-full z-[100]" style="background-color: white;">
                                <!-- JS will populate this -->
                            </ul>
                        </div>

                        <!-- Price -->
                        <div class="relative z-0">
                            <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">3. Prix Unitaire (Ref. Origine)</label>
                            <div class="relative">
                                <input type="number" id="part_price" placeholder="0.00" class="w-full p-2 md:p-2.5 rounded-lg bg-white input-field text-lg font-bold text-slate-800" onkeydown="handleEnter(event)">
                                <span class="absolute right-3 top-3 text-xs font-bold text-slate-400">DHS</span>
                            </div>
                        </div>

                        <!-- Source Selection (OnChange triggers simulation if active) -->
                        <div class="relative z-0">
                            <label class="block text-[10px] uppercase font-bold text-slate-500 mb-2">4. Source de la pièce</label>
                            
                            <!-- INFO BOX DYNAMIQUE -->
                            <div id="source_info_box" class="mb-2 p-2 bg-blue-50 border border-blue-100 rounded text-[10px] text-blue-700 hidden info-fade-in flex items-start gap-2">
                                <i class="fa-solid fa-circle-info mt-0.5"></i>
                                <span id="source_info_text">Info...</span>
                            </div>

                            <div class="grid grid-cols-1 gap-2" onchange="handleSourceChange(); if(simulationActive) simulatePreview()">
                                <!-- Option Origine -->
                                <div class="relative">
                                    <input type="radio" name="part_source" id="source_origine" value="ORIGINE" class="peer hidden source-radio" checked>
                                    <label for="source_origine" class="flex items-center justify-between p-2 md:p-3 bg-white border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-all">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 shrink-0">
                                                <i class="fa-solid fa-certificate"></i>
                                            </div>
                                            <div>
                                                <div class="text-xs font-bold text-slate-700">Origine (Neuf)</div>
                                                <div class="text-[9px] text-slate-400">Vétusté selon âge</div>
                                            </div>
                                        </div>
                                        <i class="fa-solid fa-circle-check text-blue-600 opacity-0 transform scale-50 transition-all check-icon"></i>
                                    </label>
                                </div>

                                <!-- Option Adaptable -->
                                <div class="relative">
                                    <input type="radio" name="part_source" id="source_adaptable" value="ADAPTABLE" class="peer hidden source-radio">
                                    <label for="source_adaptable" class="flex items-center justify-between p-2 md:p-3 bg-white border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-all">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 shrink-0">
                                                <i class="fa-solid fa-clone"></i>
                                            </div>
                                            <div>
                                                <div class="text-xs font-bold text-slate-700">Adaptable</div>
                                                <div class="text-[9px] text-slate-400">Réduction fixe 50%</div>
                                            </div>
                                        </div>
                                        <i class="fa-solid fa-circle-check text-blue-600 opacity-0 transform scale-50 transition-all check-icon"></i>
                                    </label>
                                </div>

                                <!-- Option Récupérable -->
                                <div class="relative">
                                    <input type="radio" name="part_source" id="source_recup" value="RECUPERABLE" class="peer hidden source-radio">
                                    <label for="source_recup" class="flex items-center justify-between p-2 md:p-3 bg-white border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-all">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-full bg-amber-50 flex items-center justify-center text-amber-600 shrink-0">
                                                <i class="fa-solid fa-recycle"></i>
                                            </div>
                                            <div>
                                                <div class="text-xs font-bold text-slate-700">Récupérable / Occasion</div>
                                                <div class="text-[9px] text-slate-400">Réduction Marché (Editable)</div>
                                            </div>
                                        </div>
                                        <i class="fa-solid fa-circle-check text-blue-600 opacity-0 transform scale-50 transition-all check-icon"></i>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Dynamic Input for ORIGINE Rate Override -->
                            <div id="origine_rate_container" class="mt-2 bg-slate-50 border border-slate-200 p-3 rounded-lg animate-fade-in">
                                <div class="flex items-center justify-between mb-1">
                                    <label class="text-[10px] uppercase font-bold text-slate-600">Taux Expert (%)</label>
                                    <span class="text-[9px] text-slate-400">Matrice : <span id="calc_matrix_rate" class="font-bold">--%</span></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="manual_origine_rate" class="w-full p-2 text-center font-bold text-slate-800 bg-white border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-slate-500" placeholder="Automatique" onchange="if(simulationActive) simulatePreview()">
                                </div>
                                <p class="text-[9px] text-slate-400 mt-1 italic"><i class="fa-solid fa-pen-to-square mr-1"></i>Modifiable manuellement selon état (Km, entretien...)</p>
                            </div>

                            <!-- Dynamic SLIDER for Recup Rate -->
                            <div id="recup_rate_container" class="hidden mt-3 bg-amber-50 border border-amber-200 p-4 rounded-lg animate-fade-in shadow-sm">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-[10px] uppercase font-bold text-amber-800">Taux Réduction Marché</label>
                                    <span id="recup_rate_display" class="font-bold text-lg text-amber-700 bg-white px-2 rounded shadow-sm border border-amber-100">60%</span>
                                </div>
                                <div class="relative w-full h-6 flex items-center">
                                    <input type="range" id="recup_rate" min="0" max="90" step="5" value="60" class="w-full h-2 bg-amber-200 rounded-lg appearance-none cursor-pointer" oninput="updateRecupDisplay(this.value)">
                                </div>
                                <div class="flex justify-between text-[9px] text-amber-600 font-medium px-1 mt-1">
                                    <span>0%</span>
                                    <span>30%</span>
                                    <span>60%</span>
                                    <span>90%</span>
                                </div>
                                <p class="text-[9px] text-amber-600 mt-2 italic"><i class="fa-solid fa-arrow-trend-down mr-1"></i>Estimez la différence entre prix neuf et occasion.</p>
                            </div>
                        </div>

                        <!-- PREVIEW BOX -->
                        <div id="preview_box" class="hidden bg-slate-800 rounded-xl p-4 text-white shadow-lg animate-fade-in relative z-0">
                            <div class="flex justify-between items-start mb-2 border-b border-slate-600 pb-2">
                                <span class="text-[10px] uppercase font-bold text-slate-400">Résultat Simulation</span>
                                <span id="preview_source" class="text-xs font-bold text-yellow-400">ORIGINE</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-[10px] text-slate-400">Taux / Vétusté</div>
                                    <div id="preview_rate" class="text-sm font-bold text-white">0%</div>
                                    <div id="preview_deduction" class="text-lg font-bold text-rose-400">-0,00</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-[10px] text-slate-400">Net à Payer</div>
                                    <div id="preview_net" class="text-xl font-bold text-emerald-400">0,00</div>
                                </div>
                            </div>
                        </div>

                        <!-- ACTION BUTTONS -->
                        <div class="flex gap-2 mt-2 relative z-0">
                            <button onclick="simulatePreview()" class="flex-1 py-3 bg-indigo-100 text-indigo-700 rounded-xl text-sm font-bold hover:bg-indigo-200 transition-colors">
                                <i class="fa-solid fa-calculator mr-2"></i>Simuler
                            </button>
                            <button onclick="addPart()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-700 hover:shadow-emerald-300 transition-all active:scale-95">
                                <i class="fa-solid fa-plus mr-2"></i>Ajouter
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: RESULTS -->
            <div class="lg:col-span-8 space-y-4 md:space-y-6">
                <!-- SUMMARY CARDS -->
                <div class="grid grid-cols-3 gap-2 md:gap-4">
                    <div class="bg-white p-3 md:p-4 rounded-xl md:rounded-2xl border border-slate-100 shadow-sm flex flex-col justify-center items-center text-center">
                        <p class="text-[9px] md:text-[10px] uppercase font-bold text-slate-400 mb-1">Total Pièces</p>
                        <p id="sum_total" class="text-lg md:text-2xl font-bold text-slate-800 tracking-tight break-all">0,00 <span class="hidden md:inline text-xs font-normal text-slate-400">Dhs</span></p>
                    </div>
                    <div class="bg-rose-50 p-3 md:p-4 rounded-xl md:rounded-2xl border border-rose-100 shadow-sm flex flex-col justify-center items-center text-center">
                        <p class="text-[9px] md:text-[10px] uppercase font-bold text-rose-400 mb-1">Vétusté / Réd.</p>
                        <p id="sum_vetuste" class="text-lg md:text-2xl font-bold text-rose-600 tracking-tight break-all">0,00 <span class="hidden md:inline text-xs font-normal text-rose-400">Dhs</span></p>
                    </div>
                    <div class="bg-emerald-50 p-3 md:p-4 rounded-xl md:rounded-2xl border border-emerald-100 shadow-sm flex flex-col justify-center items-center text-center">
                        <p class="text-[9px] md:text-[10px] uppercase font-bold text-emerald-400 mb-1">Total Devis (Net)</p>
                        <p id="sum_net" class="text-lg md:text-2xl font-bold text-emerald-600 tracking-tight break-all">0,00 <span class="hidden md:inline text-xs font-normal text-emerald-400">Dhs</span></p>
                    </div>
                </div>

                <!-- TABLE -->
                <div class="glass-panel rounded-2xl overflow-hidden min-h-[400px] flex flex-col">
                    <div class="p-3 md:p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Détail des Lignes</h3>
                        <span id="row_count" class="bg-slate-200 text-slate-600 text-[10px] font-bold px-2 py-1 rounded-md">0 lignes</span>
                    </div>
                    
                    <div class="overflow-x-auto flex-grow">
                        <table class="w-full text-left border-collapse min-w-[320px]">
                            <thead>
                                <tr class="text-[9px] md:text-[10px] font-bold text-slate-400 uppercase border-b border-slate-100 bg-white text-center">
                                    <th class="p-2 md:p-4 text-left">Pièce</th>
                                    <th class="p-2 md:p-4">Source</th>
                                    <th class="p-2 md:p-4 text-center">Prix Orig.</th>
                                    <th class="p-2 md:p-4">Taux</th>
                                    <th class="p-2 md:p-4 text-center">Déduc.</th>
                                    <th class="p-2 md:p-4 text-center">Prix Net</th>
                                    <th class="p-2 md:p-4"></th>
                                </tr>
                            </thead>
                            <tbody id="parts_table_body" class="text-xs md:text-sm font-medium text-slate-700 divide-y divide-slate-50 bg-white">
                                <!-- Rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center text-[10px] text-slate-400 font-medium uppercase tracking-widest mt-8 no-print">
            © BETCAM | Module Indépendant V.21.0
        </div>

    </div>

    <!-- PDF TEMPLATE (Hidden) -->
    <div id="pdf-template" class="bg-white text-black p-8 max-w-[210mm] mx-auto">
        <!-- Header PDF -->
        <div class="flex justify-between items-end border-b-2 border-black pb-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold uppercase tracking-tight">Cabinet BETCAM</h1>
                <p class="text-xs font-medium uppercase tracking-widest mt-1">État Détaillé de Vétusté</p>
            </div>
            <div class="text-right text-xs space-y-1">
                <p>Date: <span id="pdf_date">--/--/----</span></p>
                <div class="mt-2 bg-gray-100 p-1 border border-gray-200">
                    <p class="text-[10px] uppercase font-bold text-gray-500">Réf. Classement</p>
                    <p class="text-base font-bold text-black" id="pdf_ref">--</p>
                </div>
                <p class="mt-1">Immat: <span id="pdf_immat" class="font-bold">--</span></p>
            </div>
        </div>

        <!-- Info Dossier PDF -->
        <div class="bg-gray-50 p-4 rounded border border-gray-200 mb-6 text-sm">
            <div class="grid grid-cols-2 gap-4">
                <div><span class="font-bold">MEC :</span> <span id="pdf_mec">--</span></div>
                <div><span class="font-bold">Sinistre :</span> <span id="pdf_sinistre">--</span></div>
                <div><span class="font-bold">Catégorie :</span> <span id="pdf_cat">--</span></div>
                <div><span class="font-bold">Année appliquée :</span> <span id="pdf_age">--</span></div>
            </div>
        </div>

        <!-- Table PDF -->
        <table class="w-full text-xs border-collapse mb-8">
            <thead>
                <tr class="bg-gray-100 border-y border-black font-bold text-left uppercase">
                    <th class="p-2">Famille</th>
                    <th class="p-2">Désignation</th>
                    <th class="p-2 text-center">Source</th>
                    <th class="p-2 text-right">Prix Unit.</th>
                    <th class="p-2 text-center">Taux</th>
                    <th class="p-2 text-right">Retenue</th>
                    <th class="p-2 text-right">Prix Net</th>
                </tr>
            </thead>
            <tbody id="pdf_table_body" class="divide-y divide-gray-200">
                <!-- Content -->
            </tbody>
        </table>

        <!-- Totals PDF -->
        <div class="flex justify-end">
            <div class="w-1/2">
                <div class="flex justify-between py-2 border-b border-gray-300 text-sm">
                    <span>Total Pièces (TTC)</span>
                    <span id="pdf_total_brut" class="font-bold">0,00</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-300 text-sm">
                    <span>Total Vétusté / Réd.</span>
                    <span id="pdf_total_vetuste" class="font-bold text-red-600">- 0,00</span>
                </div>
                <div class="flex justify-between py-3 border-b-2 border-black text-base font-bold bg-gray-50 px-2 mt-2">
                    <span>Total Devis Estimatif (Net)</span>
                    <span id="pdf_total_net">0,00 Dhs</span>
                </div>
            </div>
        </div>

        <div class="mt-12 text-[9px] text-center text-gray-500 uppercase">
            Document généré électroniquement • Algorithme conforme aux règles techniques.
        </div>
    </div>

    <script>
        // --- DATA: CATALOGUE PIECES (CATEGORISÉ) ---
        const PARTS_DB = {
            CARROSSERIE: {
                "PC / CALANDRE / ARMATURE": [
                    "Pare-chocs Avant", "Pare-chocs Arrière", "Calandre", "Armature Pare-chocs", 
                    "Spoiler", "Jupe avant", "Jupe arrière", "Support pare-chocs", 
                    "Grille calandre", "Grille aération", "Moulure", "Baguette de porte"
                ],
                "TÔLERIE & STRUCTURE": [
                    "Capot", "Aile Avant Droite", "Aile Avant Gauche", "Aile Arrière Droite", "Aile Arrière Gauche", 
                    "Portière Avant Droite", "Portière Avant Gauche", "Portière Arrière Droite", "Portière Arrière Gauche", 
                    "Coffre / Hayon", "Toit / Pavillon", "Bas de Caisse", "Longeron", 
                    "Traverse Avant", "Traverse Arrière", "Face Avant", "Face arrière", 
                    "Passage de Roue", "Plancher", "Charnière capot", "Charnière porte", 
                    "Serrure porte", "Serrure coffre", "Gâche de serrure", 
                    "Vérin de coffre", "Vérin de capot", "Trappe à essence"
                ],
                "VITRAGE & RÉTROVISEURS": [
                    "Pare-brise", "Lunette Arrière", "Vitre Latérale", "Custode", 
                    "Rétroviseur Droit", "Rétroviseur Gauche", "Lève-vitre", 
                    "Manivelle vitre", "Baie de pare-brise"
                ],
                "ECLAIRAGE & SIGNALISATION": [
                    "Phare Avant Droit", "Phare Avant Gauche", "Feu Arrière Droit", "Feu Arrière Gauche", 
                    "Antibrouillard", "Clignotant", "Répétiteur aile", "Feu stop central", "Eclaireur de plaque"
                ],
                "ACCESSOIRES / DIVERS": [
                    "Logo / Sigle", "Enjoliveur aile", "Garde-boue", "Protection sous moteur", 
                    "Insonorisant capot", "Ceinture de sécurité", "Tableau de bord", "Ciel de toit"
                ]
            },
            MECANIQUE: {
                "MOTEUR & ALIMENTATION": [
                    "Moteur Complet", "Culasse", "Carter Huile", "Turbo", "Compresseur Turbo", 
                    "Injecteurs", "Pompe à Injection", "Pompe à Huile", "Pompe de gavage", 
                    "Débitmètre", "Boitier Papillon", "Collecteur admission", "Collecteur échappement", 
                    "Vanne EGR", "Support moteur", "Silentbloc", "Poulie Damper", 
                    "Vilebrequin", "Arbre à cames", "Piston", "Soupape", "Bielle", 
                    "Jauge à huile", "Réservoir carburant"
                ],
                "REFROIDISSEMENT & CLIM": [
                    "Radiateur Moteur", "Radiateur Huile", "Radiateur Chauffage", "Ventilateur", 
                    "Intercooler", "Condenseur Clim", "Compresseur Clim", "Pompe à Eau", 
                    "Thermostat", "Durite eau", "Bocal refroidissement"
                ],
                "TRANSMISSION & BOÎTE": [
                    "Boîte de Vitesses", "Boîte de transfert", "Embrayage (Volant Moteur)", 
                    "Emetteur embrayage", "Récepteur embrayage", "Câble embrayage", "Levier vitesse", 
                    "Cardan Droit", "Cardan Gauche", "Arbre de transmission", "Pont arrière", 
                    "Moyeu de Roue", "Huile de Boîte", "Huile de Pont"
                ],
                "TRAINS ROULANTS & DIRECTION": [
                    "Amortisseur Avant", "Amortisseur Arrière", "Triangle Suspension", 
                    "Rotule suspension", "Rotule direction", "Crémaillère Direction", 
                    "Pompe de Direction", "Berceau Moteur", "Train Avant", "Train Arrière", 
                    "Barre stabilisatrice", "Fusée", "Ressort suspension"
                ],
                "FREINAGE (HYDRAULIQUE)": [
                    "Maitre cylindre", "Servo-frein", "Etrier de frein", "Cylindre de roue", 
                    "Bloc ABS", "Câble frein main", "Bocal liquide frein"
                ],
                "ÉCHAPPEMENT": [
                    "Échappement (Ligne)", "Silencieux", "Catalyseur / FAP", 
                    "Filtre à particules", "Sonde Lambda"
                ],
                "ÉLECTRICITÉ & DÉMARRAGE": [
                    "Alternateur", "Démarreur", "Batterie (Non Usure)", "Calculateur Moteur", 
                    "Calculateur Airbag", "Faisceau Électrique", "Bobine allumage", "Neiman", 
                    "Sonde température", "Moteur essuie-glace", "Comodo"
                ]
            },
            USURE: {
                "FREINAGE (CONSOMMABLE)": [
                    "Plaquettes de Frein AV", "Plaquettes de Frein AR", 
                    "Disques de Frein AV", "Disques de Frein AR", "Liquide de Frein"
                ],
                "FILTRATION & VIDANGE": [
                    "Filtre à Huile", "Filtre à Air", "Filtre Carburant", "Filtre Habitacle", 
                    "Huile Moteur", "Bouchon vidange"
                ],
                "PNEUMATIQUES": [
                    "Pneu Avant", "Pneu Arrière", "Jante (Si usée)"
                ],
                "DISTRIBUTION & COURROIES": [
                    "Kit Distribution", "Courroie Accessoire", "Courroie Distribution", 
                    "Galet tendeur", "Pompe à Eau (Kit)"
                ],
                "VISIBILITÉ": [
                    "Essuie-glaces", "Balais d'essuie-glace", "Lave-glace", "Ampoules"
                ],
                "DIVERS ENTRETIEN": [
                    "Batterie (Standard)", "Bougies (Allumage/Préchauffage)", 
                    "Recharge Clim", "Silencieux Échappement (Usure)"
                ]
            }
        };

        const MATRICES = {
            CARROSSERIE: { A: { rates: [0, 5, 10, 15, 20, 25], cap: 50 }, B: { rates: [10, 20, 30, 40, 50, 50], cap: 50 } },
            MECANIQUE: { A: { rates: [5, 10, 15, 20, 25, 30], cap: 60 }, B: { rates: [10, 20, 30, 40, 50, 50], cap: 60 } },
            USURE: { A: { rates: [15, 30, 45, 60], cap: 60 }, B: { rates: [25, 50, 70], cap: 70 } }
        };

        const LABELS = {
            CARROSSERIE: { label: "Carrosserie", color: "indigo", placeholder: "Ex: Pare-chocs, Aile..." },
            MECANIQUE: { label: "Mécanique", color: "blue", placeholder: "Ex: Radiateur, Alternateur..." },
            USURE: { label: "Pièce d'Usure", color: "orange", placeholder: "Ex: Pneus, Filtre, Freins..." }
        };

        const SOURCE_CONFIG = {
            ORIGINE: { 
                label: "Origine", 
                short: "ORIG.", 
                colorClass: "bg-slate-100 text-slate-700 border-slate-200",
                info: "Prix de la pièce neuve Constructeur avec application de la vétusté standard."
            },
            ADAPTABLE: { 
                label: "Adaptable", 
                short: "ADAPT.", 
                colorClass: "bg-indigo-100 text-indigo-700 border-indigo-200",
                info: "Prix de la pièce neuve Générique. Application d'une réduction forfaitaire de 50% sur le prix origine."
            },
            RECUPERABLE: { 
                label: "Récupérable", 
                short: "RÉCUP.", 
                colorClass: "bg-amber-100 text-amber-800 border-amber-200",
                info: "Prix du marché de l'occasion. Ajustez le curseur pour définir le coût réel d'acquisition."
            }
        };

        let parts = [];
        let simulationActive = false;
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            checkForSavedData(); // Check LS on load
            const today = new Date().toISOString().split('T')[0];
            if(!document.getElementById('date_sinistre').value) {
               document.getElementById('date_sinistre').value = today;
            }
            calcAge();
            renderTable(); 
            handleSourceChange(); // Init info text
            
            // Close suggestion box when clicking outside
            document.addEventListener('click', function(e) {
                const input = document.getElementById('part_name');
                const list = document.getElementById('custom_suggestions');
                if (e.target.closest('#custom_suggestions') || e.target === input) {
                    return;
                }
                list.classList.add('hidden');
            });
        });

        // --- LOCAL STORAGE LOGIC ---
        function saveData() {
            const data = {
                ref_dossier: document.getElementById('ref_dossier').value,
                ref_immat: document.getElementById('ref_immat').value,
                date_mec: document.getElementById('date_mec').value,
                date_sinistre: document.getElementById('date_sinistre').value,
                cat_vehicule: document.getElementById('cat_vehicule').value,
                parts: parts
            };
            localStorage.setItem('betcam_expert_data', JSON.stringify(data));
        }

        function checkForSavedData() {
            const saved = localStorage.getItem('betcam_expert_data');
            if (saved) {
                document.getElementById('restore_notification').style.display = 'flex';
            }
        }

        function dismissRestore() {
            document.getElementById('restore_notification').style.display = 'none';
            localStorage.removeItem('betcam_expert_data');
        }

        function performRestore() {
            const saved = localStorage.getItem('betcam_expert_data');
            if (saved) {
                const data = JSON.parse(saved);
                document.getElementById('ref_dossier').value = data.ref_dossier || "";
                document.getElementById('ref_immat').value = data.ref_immat || "";
                document.getElementById('date_mec').value = data.date_mec || "";
                document.getElementById('date_sinistre').value = data.date_sinistre || "";
                document.getElementById('cat_vehicule').value = data.cat_vehicule || "A";
                parts = data.parts || [];
                
                calcAge();
                renderTable();
                document.getElementById('restore_notification').style.display = 'none';
            }
        }

        function handleEnter(e) {
            if(e.key === "Enter") addPart();
        }

        // --- CUSTOM DROPDOWN LOGIC ---
        function clearInput() {
            const input = document.getElementById('part_name');
            input.value = "";
            showSuggestions(); 
            input.focus();
        }

        function resetAndFilterSuggestions() {
            const input = document.getElementById('part_name');
            const type = document.getElementById('part_type').value;
            input.placeholder = LABELS[type].placeholder;
            input.value = ""; 
        }

        function showSuggestions() {
            filterSuggestions();
        }

        function filterSuggestions() {
            const input = document.getElementById('part_name');
            const filter = input.value.toUpperCase();
            const type = document.getElementById('part_type').value;
            const ul = document.getElementById('custom_suggestions');
            
            ul.innerHTML = "";
            let count = 0;

            if (PARTS_DB[type]) {
                // Iteration sur les catégories (sous-objets)
                for (const [category, items] of Object.entries(PARTS_DB[type])) {
                    // Filtrage des items dans cette catégorie
                    const sortedItems = [...items].sort((a, b) => a.localeCompare(b));
                    const matchingItems = sortedItems.filter(item => item.toUpperCase().indexOf(filter) > -1);
                    
                    if (matchingItems.length > 0) {
                        // Ajouter le header de catégorie
                        const catHeader = document.createElement('li');
                        catHeader.className = "suggestion-header";
                        catHeader.textContent = category;
                        ul.appendChild(catHeader);

                        // Ajouter les items
                        matchingItems.forEach(item => {
                            const li = document.createElement('li');
                            li.className = "suggestion-item";
                            li.textContent = item;
                            li.onclick = function() {
                                selectSuggestion(item);
                            };
                            ul.appendChild(li);
                            count++;
                        });
                    }
                }
            }

            if (count > 0) {
                ul.classList.remove('hidden');
            } else {
                ul.classList.add('hidden');
            }
        }

        function selectSuggestion(val) {
            document.getElementById('part_name').value = val;
            document.getElementById('custom_suggestions').classList.add('hidden');
            document.getElementById('part_price').focus();
        }

        // --- CORE LOGIC ---

        function calcAge() {
            const mecStr = document.getElementById('date_mec').value;
            const sinStr = document.getElementById('date_sinistre').value;
            
            if (!mecStr || !sinStr) return;

            const mec = new Date(mecStr);
            const sin = new Date(sinStr);
            
            let months = (sin.getFullYear() - mec.getFullYear()) * 12;
            months -= mec.getMonth();
            months += sin.getMonth();
            
            if (sin.getDate() < mec.getDate()) months--;

            let yearStarted = Math.max(1, Math.floor(months / 12) + 1);

            document.getElementById('display_age').innerText = yearStarted + (yearStarted === 1 ? "ère année" : "ème année");
            document.getElementById('calculated_year').value = yearStarted;
            
            updateOrigineDisplay();
            recalcAll();
        }

        // Helper to get standard rate without reduction
        function getStandardRate(type, category, year) {
            const matrix = MATRICES[type][category];
            let rate = 0;
            if (year <= matrix.rates.length) {
                rate = matrix.rates[year - 1];
            } else {
                rate = matrix.rates[matrix.rates.length - 1]; 
            }
            return Math.min(rate, matrix.cap);
        }

        function handleSourceChange() {
            const source = getSelectedSource();
            const recupDiv = document.getElementById('recup_rate_container');
            const origineDiv = document.getElementById('origine_rate_container');
            const infoBox = document.getElementById('source_info_box');
            
            // Affichage Info Contextuelle
            infoBox.classList.remove('hidden');
            document.getElementById('source_info_text').innerText = SOURCE_CONFIG[source].info;

            if(source === 'RECUPERABLE') {
                recupDiv.classList.remove('hidden');
                origineDiv.classList.add('hidden');
            } else if (source === 'ORIGINE') {
                recupDiv.classList.add('hidden');
                origineDiv.classList.remove('hidden');
                updateOrigineDisplay();
            } else {
                recupDiv.classList.add('hidden');
                origineDiv.classList.add('hidden');
            }
        }

        function updateOrigineDisplay() {
            const type = document.getElementById('part_type').value;
            const cat = document.getElementById('cat_vehicule').value;
            const year = parseInt(document.getElementById('calculated_year').value) || 1;
            const stdRate = getStandardRate(type, cat, year);
            
            document.getElementById('calc_matrix_rate').innerText = stdRate + "%";
            
            // Only autofill if empty, allowing manual override to persist
            const manualInput = document.getElementById('manual_origine_rate');
            if(!manualInput.value) {
                manualInput.placeholder = stdRate + "% (Auto)";
            }
        }

        function updateRecupDisplay(val) {
            document.getElementById('recup_rate_display').innerText = val + "%";
            if(simulationActive) simulatePreview();
        }

        function getRate(type, category, year, source) {
            if (source === 'RECUPERABLE') {
                // Return value from slider
                const manualRate = parseFloat(document.getElementById('recup_rate').value) || 60;
                return manualRate;
            }
            if (source === 'ADAPTABLE') return 50; 
            if (source === 'ORIGINE') {
                // Return manually forced rate OR standard rate if empty
                const manualRate = document.getElementById('manual_origine_rate').value;
                if(manualRate !== "") return parseFloat(manualRate);
                return getStandardRate(type, category, year);
            }
            return 0;
        }

        function getSelectedSource() {
            const sourceRadios = document.getElementsByName('part_source');
            for (const radio of sourceRadios) {
                if (radio.checked) return radio.value;
            }
            return 'ORIGINE';
        }

        function simulatePreview() {
            const price = parseFloat(document.getElementById('part_price').value);
            if (!price || price <= 0) return;

            const type = document.getElementById('part_type').value;
            const cat = document.getElementById('cat_vehicule').value;
            const year = parseInt(document.getElementById('calculated_year').value) || 1;
            const source = getSelectedSource();

            let finalRate = getRate(type, cat, year, source);
            
            const deduction = price * (finalRate / 100);
            const net = price - deduction;

            document.getElementById('preview_source').innerText = SOURCE_CONFIG[source].label;
            
            let rateDisplay = finalRate.toString().replace('.', ',') + "%";
            
            if (source === 'ADAPTABLE') {
                rateDisplay = "50% (Réduction Fixe)";
            } else if (source === 'RECUPERABLE') {
                rateDisplay = finalRate + "% (Marché)";
            } else if (source === 'ORIGINE') {
                const std = getStandardRate(type, cat, year);
                if(finalRate !== std) {
                    rateDisplay += ` (Expert)`;
                } else {
                    rateDisplay += ` (Standard)`;
                }
            }

            document.getElementById('preview_rate').innerHTML = rateDisplay;
            document.getElementById('preview_deduction').innerText = "-" + formatMoney(deduction);
            document.getElementById('preview_net').innerText = formatMoney(net);

            const box = document.getElementById('preview_box');
            box.classList.remove('hidden');
            simulationActive = true;
        }

        function addPart() {
            const nameInput = document.getElementById('part_name');
            const name = nameInput.value.trim() || "Pièce diverse";
            const type = document.getElementById('part_type').value;
            const price = parseFloat(document.getElementById('part_price').value);
            const source = getSelectedSource();

            if (!price || price <= 0) {
                alert("Veuillez saisir un prix valide.");
                return;
            }

            const id = Date.now();
            const cat = document.getElementById('cat_vehicule').value;
            const year = parseInt(document.getElementById('calculated_year').value) || 1;
            const usedRate = getRate(type, cat, year, source);

            parts.push({ id, name, type, price, source, rate: usedRate });
            saveData(); // Save to LS
            
            // Reset fields
            nameInput.value = "";
            document.getElementById('part_price').value = "";
            document.getElementById('source_origine').checked = true;
            document.getElementById('manual_origine_rate').value = ""; // Clear manual override
            handleSourceChange(); // Reset UI inputs
            
            document.getElementById('preview_box').classList.add('hidden');
            simulationActive = false;
            document.getElementById('custom_suggestions').classList.add('hidden');

            renderTable();
        }

        function removePart(id) {
            parts = parts.filter(p => p.id !== id);
            saveData(); // Save to LS
            renderTable();
        }

        function recalcAll() {
            renderTable();
            if(simulationActive) simulatePreview();
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('fr-MA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount);
        }

        function renderTable() {
            const tbody = document.getElementById('parts_table_body');
            
            if (parts.length === 0) {
                tbody.innerHTML = `
                    <tr id="empty_state">
                        <td colspan="7" class="p-6 md:p-12 text-center text-slate-400">
                            <i class="fa-solid fa-basket-shopping text-3xl mb-3 opacity-20"></i>
                            <p class="text-xs font-normal">Aucune pièce ajoutée.<br>Remplissez le formulaire.</p>
                        </td>
                    </tr>`;
                updateTotals(0, 0);
                document.getElementById('row_count').innerText = "0 lignes";
                return;
            }

            let html = "";
            let totalBrut = 0;
            let totalVetuste = 0;

            parts.forEach(part => {
                const deduction = part.price * (part.rate / 100);
                const net = part.price - deduction;
                totalBrut += part.price;
                totalVetuste += deduction;

                const style = LABELS[part.type];
                const sourceConfig = SOURCE_CONFIG[part.source];
                
                let rateDisplay = `<span class="font-bold text-xs md:text-sm ${part.rate > 0 ? 'text-rose-500' : 'text-slate-400'}">${part.rate.toString().replace('.', ',')}%</span>`;
                if (part.source === 'ADAPTABLE') {
                    rateDisplay += `<div class="text-[9px] text-slate-300">Forfait</div>`;
                } else if (part.source === 'RECUPERABLE') {
                    rateDisplay += `<div class="text-[9px] text-slate-300">Marché</div>`;
                } else {
                     rateDisplay += `<div class="text-[9px] text-slate-300">Origine</div>`;
                }

                html += `
                    <tr class="hover:bg-slate-50 transition-colors group border-b border-slate-50">
                        <td class="p-2 md:p-4">
                            <div class="font-medium text-slate-900 line-clamp-1 text-xs md:text-sm">${part.name}</div>
                            <span class="md:hidden text-[9px] text-slate-400 font-medium tracking-wide uppercase mt-0.5 block">${style.label}</span>
                        </td>
                        <td class="p-2 md:p-4 text-center">
                            <span class="text-[9px] font-bold px-1.5 py-0.5 md:px-2 md:py-1 rounded border ${sourceConfig.colorClass} whitespace-nowrap">
                                ${sourceConfig.short}
                            </span>
                        </td>
                        <td class="p-2 md:p-4 text-center font-mono text-slate-600 font-bold whitespace-nowrap text-xs md:text-sm">${formatMoney(part.price)}</td>
                        <td class="p-2 md:p-4 text-center">
                            ${rateDisplay}
                        </td>
                        <td class="p-2 md:p-4 text-center font-mono font-bold text-rose-600 whitespace-nowrap text-xs md:text-sm">-${formatMoney(deduction)}</td>
                        <td class="p-2 md:p-4 text-center font-mono font-bold text-emerald-600 whitespace-nowrap text-xs md:text-sm">${formatMoney(net)}</td>
                        <td class="p-2 md:p-4 text-center">
                            <button onclick="removePart(${part.id})" class="text-slate-300 hover:text-rose-500 transition-colors p-1 md:p-2">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
            document.getElementById('row_count').innerText = `${parts.length} ligne${parts.length > 1 ? 's' : ''}`;
            updateTotals(totalBrut, totalVetuste);
        }

        function updateTotals(brut, vetuste) {
            const net = brut - vetuste;
            document.getElementById('sum_total').innerHTML = `${formatMoney(brut)} <span class="hidden md:inline text-xs font-normal text-slate-400">Dhs</span>`;
            document.getElementById('sum_vetuste').innerHTML = `${formatMoney(vetuste)} <span class="hidden md:inline text-xs font-normal text-rose-400">Dhs</span>`;
            document.getElementById('sum_net').innerHTML = `${formatMoney(net)} <span class="hidden md:inline text-xs font-normal text-emerald-400">Dhs</span>`;
        }

        function resetApp() {
            if(confirm("Tout effacer ?")) {
                parts = [];
                document.getElementById('ref_dossier').value = "";
                document.getElementById('ref_immat').value = "";
                document.getElementById('part_name').value = "";
                document.getElementById('part_price').value = "";
                document.getElementById('source_origine').checked = true;
                document.getElementById('preview_box').classList.add('hidden');
                document.getElementById('custom_suggestions').classList.add('hidden');
                
                handleSourceChange();
                simulationActive = false;
                
                localStorage.removeItem('betcam_expert_data'); // Clear LS
                renderTable();
            }
        }

        // --- PDF EXPORT ---
        function generatePDF() {
            if (parts.length === 0) {
                alert("Ajoutez des pièces avant d'exporter.");
                return;
            }

            document.getElementById('pdf_date').innerText = new Date().toLocaleDateString('fr-FR');
            document.getElementById('pdf_ref').innerText = document.getElementById('ref_dossier').value || "N/A";
            document.getElementById('pdf_immat').innerText = document.getElementById('ref_immat').value || "N/A";
            
            const mec = document.getElementById('date_mec').value;
            const sin = document.getElementById('date_sinistre').value;
            document.getElementById('pdf_mec').innerText = mec ? new Date(mec).toLocaleDateString('fr-FR') : "--";
            document.getElementById('pdf_sinistre').innerText = sin ? new Date(sin).toLocaleDateString('fr-FR') : "--";
            
            const catVal = document.getElementById('cat_vehicule').value;
            document.getElementById('pdf_cat').innerText = catVal === "A" ? "Tourisme" : "Utilitaire/Lourd";
            document.getElementById('pdf_age').innerText = document.getElementById('display_age').innerText;

            let html = "";
            let totalBrut = 0;
            let totalVetuste = 0;

            parts.forEach(part => {
                const deduction = part.price * (part.rate / 100);
                const net = part.price - deduction;
                totalBrut += part.price;
                totalVetuste += deduction;
                
                const sourceLabel = SOURCE_CONFIG[part.source].short;

                html += `
                    <tr>
                        <td class="p-2 border-b border-gray-100">${LABELS[part.type].label}</td>
                        <td class="p-2 border-b border-gray-100 font-medium">${part.name}</td>
                        <td class="p-2 border-b border-gray-100 text-center text-[10px] font-bold">${sourceLabel}</td>
                        <td class="p-2 border-b border-gray-100 text-right">${formatMoney(part.price)}</td>
                        <td class="p-2 border-b border-gray-100 text-center">${part.rate.toString().replace('.', ',')}%</td>
                        <td class="p-2 border-b border-gray-100 text-right text-red-600">-${formatMoney(deduction)}</td>
                        <td class="p-2 border-b border-gray-100 text-right font-bold text-emerald-600">${formatMoney(net)}</td>
                    </tr>
                `;
            });

            document.getElementById('pdf_table_body').innerHTML = html;
            document.getElementById('pdf_total_brut').innerText = formatMoney(totalBrut) + " Dhs";
            document.getElementById('pdf_total_vetuste').innerText = "-" + formatMoney(totalVetuste) + " Dhs";
            document.getElementById('pdf_total_net').innerText = formatMoney(totalBrut - totalVetuste) + " Dhs";

            const element = document.getElementById('pdf-template');
            element.style.display = 'block';

            const opt = {
                margin: 10,
                filename: `Vetuste_${document.getElementById('ref_dossier').value || 'Dossier'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                element.style.display = 'none';
            });
        }
    </script>
</body>
</html>
