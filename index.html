<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BETCAM | Simulateur Vétusté Expert V44</title>
    
    <!-- Bibliothèques -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .input-field {
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
        }
        .input-field:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        #custom_suggestions {
            max-height: 250px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
        }
        
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            background-color: white; 
        }
        .suggestion-item:active { background-color: #eff6ff; }

        #pdf-template { 
            position: absolute; 
            left: -9999px; 
            top: 0;
            width: 210mm; 
            background: white;
            color: black;
        }

        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="text-slate-800 p-2 md:p-8 min-h-screen relative">

    <div class="max-w-7xl mx-auto space-y-4">
        
        <!-- HEADER -->
        <div class="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-100 no-print gap-4">
            <div class="flex items-center gap-4 w-full md:w-auto">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white text-lg shadow-lg">
                    <i class="fa-solid fa-calculator"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-900 leading-tight">Simulateur Vétusté</h1>
                    <p class="text-[10px] text-slate-500 uppercase font-medium">Cabinet BETCAM • V44 (Gestion Main d'œuvre)</p>
                </div>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <button onclick="resetApp()" class="flex-1 md:flex-none px-3 py-2 text-slate-500 text-xs font-medium bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors">
                    <i class="fa-solid fa-rotate-right"></i> Reset
                </button>
                <button onclick="generatePDF(true)" class="flex-1 md:flex-none px-4 py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold shadow-md hover:bg-indigo-700 transition-all">
                    <i class="fa-solid fa-eye mr-1"></i> Visualiser
                </button>
                <button onclick="generatePDF(false)" class="flex-1 md:flex-none px-4 py-2 bg-slate-900 text-white rounded-lg text-xs font-bold shadow-md hover:bg-slate-800 transition-all">
                    <i class="fa-solid fa-download mr-1"></i> PDF
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
            
            <!-- FORMULAIRE (GAUCHE) -->
            <div class="lg:col-span-4 space-y-4 no-print" id="form_container">
                
                <!-- CONTEXTE VEHICULE -->
                <div class="glass-panel p-4 rounded-2xl border-l-4 border-indigo-600">
                    <h2 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-car"></i> Véhicule & Dates
                    </h2>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[9px] uppercase font-bold text-slate-500 mb-1">N° Dossier</label>
                                <input type="text" id="ref_dossier" placeholder="Ex: 24-001" class="w-full p-2 rounded-lg bg-white input-field text-sm font-medium uppercase" oninput="this.value = this.value.toUpperCase()">
                            </div>
                            <div>
                                <label class="block text-[9px] uppercase font-bold text-slate-500 mb-1">Immatriculation</label>
                                <input type="text" id="ref_immat" placeholder="Ex: 12345-A-1" class="w-full p-2 rounded-lg bg-white input-field text-sm font-medium uppercase" oninput="this.value = this.value.toUpperCase()">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[9px] uppercase font-bold text-slate-500 mb-1">Marque</label>
                                <select id="veh_make" class="w-full p-2 rounded-lg bg-white input-field text-sm font-medium" onchange="updateModels()">
                                    <option value="">-- Choisir --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[9px] uppercase font-bold text-slate-500 mb-1">Modèle</label>
                                <select id="veh_model" class="w-full p-2 rounded-lg bg-white input-field text-sm font-medium">
                                    <option value="">-- Modèle --</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[9px] uppercase font-bold text-slate-500 mb-1">M.E.C</label>
                                <input type="date" id="date_mec" class="w-full p-2 rounded-lg bg-white input-field text-xs font-bold" onchange="calcAge()">
                            </div>
                            <div>
                                <label class="block text-[9px] uppercase font-bold text-slate-500 mb-1">Sinistre</label>
                                <input type="date" id="date_sinistre" class="w-full p-2 rounded-lg bg-white input-field text-xs font-bold" onchange="calcAge()">
                            </div>
                        </div>
                        <div class="bg-indigo-50 p-3 rounded-lg flex flex-col gap-1 border border-indigo-100">
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] font-bold text-indigo-800 uppercase">Âge de référence :</span>
                                <span id="display_age" class="text-sm font-black text-indigo-600 tracking-tight">--</span>
                            </div>
                            <div class="flex justify-between items-center text-[10px] border-t border-indigo-200 pt-1">
                                <span class="text-indigo-400 font-medium">Calcul précis :</span>
                                <span id="detailed_duration" class="font-bold text-indigo-700 italic text-[11px]">Saisir dates</span>
                            </div>
                            <input type="hidden" id="calculated_year" value="1">
                        </div>
                        <div>
                            <label class="block text-[9px] uppercase font-bold text-slate-500 mb-1">Catégorie Tarifaire</label>
                            <select id="cat_vehicule" class="w-full p-2 rounded-lg bg-white input-field text-xs font-bold text-indigo-600" onchange="calcAge()">
                                <option value="A">Tourisme (Cat. A)</option>
                                <option value="B">Utilitaire / PL (Cat. B)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- AJOUT PIECE OU MO -->
                <div id="piece_form_card" class="glass-panel p-4 rounded-2xl border-t-4 border-indigo-500 relative z-30 transition-all">
                    <div class="flex justify-between items-center mb-3">
                        <h2 id="form_title" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Ajouter un article</h2>
                        <button id="cancel_edit_btn" onclick="resetFormPart()" class="hidden text-[9px] font-bold text-rose-500 uppercase hover:underline">Annuler</button>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-[9px] uppercase font-bold text-slate-500 mb-1">1. Famille</label>
                            <select id="part_type" class="w-full p-2 rounded-lg bg-white input-field text-sm font-medium" onchange="toggleFormContext()">
                                <option value="CARROSSERIE">Carrosserie</option>
                                <option value="MECANIQUE">Mécanique / Électrique</option>
                                <option value="USURE">Pièces d'Usure</option>
                                <option value="MAIN_DOEUVRE">MAIN D'ŒUVRE</option>
                            </select>
                        </div>
                        <div class="relative z-50">
                            <label class="block text-[9px] uppercase font-bold text-slate-500 mb-1">2. Désignation</label>
                            <input type="text" id="part_name" placeholder="Rechercher..." class="w-full p-2.5 rounded-lg input-field text-sm font-semibold" onfocus="showSuggestions()" oninput="filterSuggestions(); simulatePreview()">
                            <ul id="custom_suggestions" class="hidden absolute left-0 right-0 top-full mt-1 bg-white z-[100] border border-slate-200"></ul>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="col-span-2">
                                <label id="price_field_label" class="block text-[9px] uppercase font-bold text-slate-500 mb-1">3. Prix Unit. HT</label>
                                <input type="number" id="part_price" placeholder="0.00" class="w-full p-2 rounded-lg input-field font-bold text-lg" oninput="simulatePreview()">
                            </div>
                            <div>
                                <label class="block text-[9px] uppercase font-bold text-slate-500 mb-1">Qté / H</label>
                                <input type="number" id="part_qty" value="1" min="1" class="w-full p-2 rounded-lg input-field font-bold text-lg text-center" oninput="simulatePreview()">
                            </div>
                        </div>

                        <!-- SECTION SPECIFIQUE PIECES (Masquée si MO) -->
                        <div id="piece_specs_container" class="space-y-3">
                            <div class="space-y-1">
                                <label class="block text-[9px] uppercase font-bold text-slate-500 mb-1">4. Source de la pièce</label>
                                <div class="grid grid-cols-1 gap-1" onchange="handleSourceChange(); simulatePreview()">
                                    <div class="flex gap-1">
                                        <input type="radio" name="part_source" id="src_orig" value="ORIGINE" class="peer hidden" checked>
                                        <label for="src_orig" class="flex-1 text-center p-2 bg-white border rounded-lg cursor-pointer text-[10px] font-bold transition-all peer-checked:bg-blue-600 peer-checked:border-blue-700 peer-checked:text-white uppercase">ORIGINE</label>
                                        <input type="radio" name="part_source" id="src_adapt" value="ADAPTABLE" class="peer hidden">
                                        <label for="src_adapt" class="flex-1 text-center p-2 bg-white border rounded-lg cursor-pointer text-[10px] font-bold transition-all peer-checked:bg-emerald-600 peer-checked:border-emerald-700 peer-checked:text-white uppercase">ADAPTABLE</label>
                                        <input type="radio" name="part_source" id="src_recup" value="RECUPERABLE" class="peer hidden">
                                        <label for="src_recup" class="flex-1 text-center p-2 bg-white border rounded-lg cursor-pointer text-[10px] font-bold transition-all peer-checked:bg-amber-500 peer-checked:border-amber-600 peer-checked:text-white uppercase">OCCASION</label>
                                    </div>
                                </div>
                            </div>
                            <div id="rate_container" class="p-2 bg-slate-50 rounded border border-slate-200">
                                <div class="flex justify-between items-center mb-1">
                                    <span id="rate_lbl" class="text-[9px] uppercase font-bold text-slate-500">Taux Neuf Réf.</span>
                                    <span id="matrix_val" class="text-[9px] font-bold text-indigo-600">--%</span>
                                </div>
                                <input type="number" id="manual_rate" class="w-full p-2 text-center font-bold bg-white rounded border" placeholder="Auto" oninput="simulatePreview()">
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button id="main_action_btn" onclick="addOrUpdatePart()" class="w-full py-3 bg-emerald-600 text-white rounded-xl text-sm font-bold shadow-lg hover:bg-emerald-700 transition-transform active:scale-95 uppercase tracking-wider">Ajouter au dossier</button>
                        </div>

                        <!-- PREVIEW BOX -->
                        <div id="preview_box" class="hidden bg-slate-800 rounded-xl p-3 text-white shadow-xl animate-in fade-in slide-in-from-top-1">
                            <div class="flex justify-between border-b border-slate-600 pb-1 mb-2">
                                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">APERCU CALCUL</span>
                                <span id="prev_src_label" class="text-[9px] font-bold text-yellow-400 uppercase">ARTICLE</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-center">
                                <div><p class="text-[8px] text-slate-400 uppercase">Vétusté / Taux</p><p id="prev_rate" class="text-sm font-bold text-white">0%</p></div>
                                <div><p id="prev_ttc_label" class="text-[8px] text-slate-400 uppercase">Total Final</p><p id="prev_ttc" class="text-sm font-bold text-emerald-400">0,00</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TABLEAU (DROITE) -->
            <div class="lg:col-span-8 space-y-4">
                <div class="grid grid-cols-3 gap-2">
                    <div class="bg-white p-3 rounded-xl border shadow-sm text-center">
                        <p class="text-[8px] uppercase font-bold text-slate-400">Net HT Expertisé</p>
                        <p id="sum_net_ht" class="text-sm md:text-xl font-bold tracking-tight">0,00</p>
                    </div>
                    <div class="bg-rose-50 p-3 rounded-xl border border-rose-100 text-center">
                        <p class="text-[8px] uppercase font-bold text-rose-400">Vétusté Retenue</p>
                        <p id="sum_vetuste" class="text-sm md:text-xl font-bold text-rose-600 tracking-tight">0,00</p>
                    </div>
                    <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100 text-center">
                        <p class="text-[8px] uppercase font-bold text-emerald-400 font-bold tracking-widest">TOTAL DEVIS TTC</p>
                        <p id="sum_net_ttc" class="text-sm md:text-xl font-bold text-emerald-600 tracking-tight">0,00</p>
                    </div>
                </div>
                
                <div class="glass-panel rounded-2xl overflow-hidden min-h-[500px]">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse min-w-[780px]">
                            <thead>
                                <tr class="text-[9px] font-bold text-slate-400 uppercase bg-slate-50 border-b">
                                    <th class="p-4">Désignation</th>
                                    <th class="p-4 text-center">Source</th>
                                    <th class="p-4 text-center">Qté</th>
                                    <th class="p-4 text-center">P.U HT</th>
                                    <th class="p-4 text-center">Taux</th>
                                    <th class="p-4 text-center">Vétusté</th>
                                    <th class="p-4 text-center text-slate-900 font-bold">Net HT</th>
                                    <th class="p-4 text-center text-indigo-600 font-bold">TOTAL LIGNE</th>
                                    <th class="p-4"></th>
                                </tr>
                            </thead>
                            <tbody id="parts_table_body" class="text-xs divide-y bg-white"></tbody>
                        </table>
                    </div>
                    <div id="empty_msg" class="p-20 text-center text-slate-300">
                        <i class="fa-solid fa-folder-open text-4xl mb-2 opacity-10"></i>
                        <p>Dossier vide. Ajoutez des pièces ou de la main d'œuvre.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF TEMPLATE -->
    <div id="pdf-template">
        <div style="padding: 40px; font-family: 'Helvetica', sans-serif;">
            <div style="display:flex; justify-content:space-between; border-bottom: 2px solid #000; padding-bottom: 10px;">
                <div>
                    <h1 style="font-size: 24px; font-weight: 800; margin:0;">CABINET BETCAM</h1>
                    <p style="font-size: 10px; margin-top:2px; font-weight:600;">EXPERTISE TECHNIQUE AUTOMOBILE</p>
                </div>
                <div style="text-align: right; font-size: 10px;">
                    <p>Date : <span id="pdf_date"></span></p>
                    <p style="font-weight: bold; margin-top:5px;">Réf Dossier : <span id="pdf_ref"></span></p>
                </div>
            </div>

            <div style="margin: 20px 0; padding: 15px; background-color: #f8fafc; font-size: 10px; border: 1px solid #e2e8f0; border-radius: 4px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <p><strong>Véhicule :</strong> <span id="pdf_vehicle_name"></span></p>
                <p><strong>Immatriculation :</strong> <span id="pdf_immat"></span></p>
                <p><strong>M.E.C :</strong> <span id="pdf_mec"></span></p>
                <p><strong>Catégorie :</strong> <span id="pdf_cat"></span></p>
                <p><strong>Âge appliqué :</strong> <span id="pdf_age"></span></p>
                <p style="grid-column: span 2; border-top: 1px dashed #cbd5e1; padding-top: 5px;"><strong>Détail période :</strong> <span id="pdf_detailed_age"></span></p>
            </div>

            <table style="width: 100%; border-collapse: collapse; font-size: 8px; margin-top: 15px;">
                <thead>
                    <tr style="background-color: #f1f5f9; border-bottom: 1px solid #000; font-weight: bold; text-transform: uppercase;">
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #000;">Désignation / Source</th>
                        <th style="padding: 8px; text-align: center; border-bottom: 1px solid #000;">Qté</th>
                        <th style="padding: 8px; text-align: right; border-bottom: 1px solid #000;">Unit. HT</th>
                        <th style="padding: 8px; text-align: center; border-bottom: 1px solid #000;">Taux</th>
                        <th style="padding: 8px; text-align: right; border-bottom: 1px solid #000;">Vétusté</th>
                        <th style="padding: 8px; text-align: right; border-bottom: 1px solid #000;">Net HT</th>
                        <th style="padding: 8px; text-align: right; border-bottom: 1px solid #000;">Total Ligne</th>
                    </tr>
                </thead>
                <tbody id="pdf_table_body"></tbody>
            </table>

            <div style="margin-top: 30px; display: flex; justify-content: flex-end;">
                <div style="width: 320px;">
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; font-size: 10px;">
                        <span>Total Net HT (Fourn. + M.O) :</span><span id="pdf_total_ht"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; font-size: 10px;">
                        <span>TVA (20% hors occasion) :</span><span id="pdf_tva"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #000; font-size: 10px; color: #e11d48;">
                        <span>Vétusté retenue :</span><span id="pdf_total_vet"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; font-size: 14px; font-weight: 800; background-color: #f1f5f9;">
                        <span>TOTAL GÉNÉRAL TTC :</span><span id="pdf_total_net_ttc"></span>
                    </div>
                </div>
            </div>
            <div style="margin-top: 60px; text-align: center; font-size: 8px; color: #94a3b8; text-transform: uppercase;">Cabinet BETCAM • Document à caractère technique d'expertise</div>
        </div>
    </div>

    <script>
        // --- DATA CATALOGUE COMPLET V44 ---
        const VEHICLES_DB = {
            "DACIA": ["Logan", "Sandero", "Sandero Stepway", "Duster", "Jogger", "Lodgy", "Dokker", "Spring"],
            "RENAULT": ["Clio", "Megane", "Captur", "Austral", "Express", "Kangoo", "Master", "Trafic"],
            "PEUGEOT": ["208", "2008", "308", "3008", "408", "508", "Partner", "Rifter", "Expert"],
            "VOLKSWAGEN": ["Golf", "Polo", "Tiguan", "Touareg", "T-Roc", "Passat", "Caddy", "Transporter"],
            "TOYOTA": ["Yaris", "Corolla", "Rav4", "Hilux", "Land Cruiser", "Prado"],
            "HYUNDAI": ["i10", "i20", "i30", "Tucson", "Santa Fe", "Accent", "Creta"],
            "KIA": ["Picanto", "Rio", "Sportage", "Sorento", "K5", "Sonet", "Seltos"],
            "CITROËN": ["C3", "C4", "C5 Aircross", "Berlingo", "Jumper"],
            "FORD": ["Fiesta", "Focus", "Kuga", "Ranger", "Transit"],
            "FIAT": ["500", "Panda", "Tipo", "Doblo", "Fiorino", "Ducato"],
            "MERCEDES": ["Classe A", "Classe C", "Classe E", "Classe S", "GLA", "GLC", "Sprinter"],
            "BMW": ["Série 1", "Série 3", "Série 5", "X1", "X3", "X5", "X6"],
            "AUDI": ["A1", "A3", "A4", "A6", "Q3", "Q5", "Q8"],
            "AUTRES": ["Modèle Spécifique"]
        };

        const PARTS_DB = {
            CARROSSERIE: ["Aile AV DR", "Aile AV G", "Aile AR DR", "Aile AR G", "Bas de caisse AV DR", "Bas de caisse AV G", "Capot AV", "Hayon AR", "Porte AV DR", "Porte AV G", "Porte AR DR", "Porte AR G", "Pare-chocs AV", "Pare-chocs AR", "Pare-brise AV", "Vitre latérale", "Rétroviseur AV DR", "Rétroviseur AV G", "Phare AV DR", "Phare AV G", "Feu AR DR", "Feu AR G", "Calandre AV", "Enjoliveur", "Jante alliage"],
            MECANIQUE: ["Bloc moteur", "Culasse", "Vilebrequin", "Soupape", "Courroie distribution", "Pompe à eau", "Pompe injection", "Débitmètre air", "Turbocompresseur", "Boîte vitesses", "Cardan DR", "Cardan G", "Kit embrayage", "Crémaillère direction", "Amortisseur AV", "Amortisseur AR", "Disque frein AV", "Disque frein AR", "Étrier frein", "Calculateur moteur ECU", "Compresseur clim"],
            USURE: ["Filtre air", "Filtre huile", "Filtre carburant", "Plaquette frein AV", "Plaquette frein AR", "Kit distribution", "Pneu", "Batterie", "Huile moteur 5W30", "Huile moteur 5W40", "Liquide frein", "Liquide refroidissement", "AdBlue SCR"],
            MAIN_DOEUVRE: ["Tôlerie", "Peinture complète", "Raccord peinture", "Redressage châssis", "Dépose/Pose moteur", "M.O Mécanique", "M.O Électricité", "Diagnostic électronique", "Parallélisme / Équilibrage", "Contrôle technique", "Remplacement pare-brise"]
        };
        
        const MATRICES = {
            CARROSSERIE: { A: [0, 5, 10, 15, 20, 25], B: [10, 20, 30, 40, 50, 50] },
            MECANIQUE: { A: [5, 10, 15, 20, 25, 30], B: [10, 20, 30, 40, 50, 50] },
            USURE: { A: [15, 30, 45, 60], B: [25, 50, 70] },
            MAIN_DOEUVRE: { A: [0,0,0,0,0,0], B: [0,0,0,0,0,0] } // Toujours 0%
        };

        let parts = [];
        let simulationActive = true;
        let editingId = null;

        // --- INITIALISATION ---
        window.onload = () => {
            const makeSelect = document.getElementById('veh_make');
            Object.keys(VEHICLES_DB).sort().forEach(make => {
                const opt = document.createElement('option');
                opt.value = make; opt.textContent = make;
                makeSelect.appendChild(opt);
            });
            toggleFormContext();
        };

        function updateModels() {
            const make = document.getElementById('veh_make').value;
            const modelSelect = document.getElementById('veh_model');
            modelSelect.innerHTML = '<option value="">-- Modèle --</option>';
            if(make && VEHICLES_DB[make]) {
                VEHICLES_DB[make].sort().forEach(mod => {
                    const opt = document.createElement('option');
                    opt.value = mod; opt.textContent = mod;
                    modelSelect.appendChild(opt);
                });
            }
        }

        // --- GESTION CONTEXTE FORMULAIRE ---
        function toggleFormContext() {
            const type = document.getElementById('part_type').value;
            const pieceSpecs = document.getElementById('piece_specs_container');
            const priceLabel = document.getElementById('price_field_label');
            
            if (type === 'MAIN_DOEUVRE') {
                pieceSpecs.classList.add('hidden');
                priceLabel.innerText = "3. Montant HT (M.O)";
            } else {
                pieceSpecs.classList.remove('hidden');
                priceLabel.innerText = "3. Prix Unit. HT";
                updateMatrixUI();
            }
            resetSuggestions();
            simulatePreview();
        }

        // --- CALCULS ---
        function calcAge() {
            const m = document.getElementById('date_mec').value;
            const s = document.getElementById('date_sinistre').value;
            if(!m || !s) return;
            const start = new Date(m), end = new Date(s);
            if (end < start) { document.getElementById('detailed_duration').innerText = "Dates incohérentes"; return; }
            let years = end.getFullYear() - start.getFullYear();
            let months = end.getMonth() - start.getMonth();
            let days = end.getDate() - start.getDate();
            if (days < 0) { months--; days += new Date(end.getFullYear(), end.getMonth(), 0).getDate(); }
            if (months < 0) { years--; months += 12; }
            let yearStarted = years + 1;
            document.getElementById('display_age').innerText = yearStarted + (yearStarted === 1 ? "ère année" : "ème année");
            document.getElementById('detailed_duration').innerText = `${years} ans, ${months} mois et ${days} j.`;
            document.getElementById('calculated_year').value = yearStarted;
            updateMatrixUI();
            if (parts.length > 0) recalculateAllPartsRates(yearStarted, document.getElementById('cat_vehicule').value);
            simulatePreview();
        }

        function recalculateAllPartsRates(newYear, newCat) {
            parts = parts.map(p => {
                if (p.type === 'MAIN_DOEUVRE' || p.source === 'RECUPERABLE') return p;
                const m = MATRICES[p.type][newCat];
                const baseRate = (newYear <= m.length) ? m[newYear-1] : m[m.length-1];
                const finalRate = (p.source === 'ADAPTABLE') ? baseRate * 0.5 : baseRate;
                return { ...p, rate: finalRate };
            });
            renderTable();
        }

        function updateMatrixUI() {
            const type = document.getElementById('part_type').value;
            if(type === 'MAIN_DOEUVRE') return;
            const cat = document.getElementById('cat_vehicule').value;
            const year = parseInt(document.getElementById('calculated_year').value) || 1;
            const m = MATRICES[type][cat];
            const std = (year <= m.length) ? m[year-1] : m[m.length-1];
            document.getElementById('matrix_val').innerText = std + "%";
            document.getElementById('manual_rate').placeholder = std;
        }

        function handleSourceChange() {
            const s = document.querySelector('input[name="part_source"]:checked').value;
            document.getElementById('rate_container').classList.toggle('hidden', s === 'RECUPERABLE');
            document.getElementById('rate_lbl').innerText = (s === 'ADAPTABLE') ? "Taux Origine Réf." : "Taux Neuf Réf.";
            updateMatrixUI();
            simulatePreview();
        }

        function getCalculatedRate() {
            const type = document.getElementById('part_type').value;
            if(type === 'MAIN_DOEUVRE') return 0;

            const src = document.querySelector('input[name="part_source"]:checked').value;
            if(src === 'RECUPERABLE') return 0;

            const cat = document.getElementById('cat_vehicule').value;
            const year = parseInt(document.getElementById('calculated_year').value) || 1;
            const m = MATRICES[type][cat];
            const std = (year <= m.length) ? m[year-1] : m[m.length-1];
            const manual = document.getElementById('manual_rate').value;
            const baseRate = manual !== "" ? parseFloat(manual) : std;
            
            return src === 'ADAPTABLE' ? baseRate * 0.5 : baseRate;
        }

        function simulatePreview() {
            const p = parseFloat(document.getElementById('part_price').value);
            const q = parseInt(document.getElementById('part_qty').value) || 1;
            if(!p || p <= 0) { document.getElementById('preview_box').classList.add('hidden'); return; }
            
            const type = document.getElementById('part_type').value;
            const r = getCalculatedRate();
            const netHT = (p * q) * (1 - r/100);
            const src = document.querySelector('input[name="part_source"]:checked').value;

            // Règle TVA V40-44: Pas de TVA sur Récupérable. M.O = 20% TVA.
            const isOccasion = (src === 'RECUPERABLE' && type !== 'MAIN_DOEUVRE');
            const finalVal = isOccasion ? netHT : netHT * 1.2;

            document.getElementById('prev_src_label').innerText = (type === 'MAIN_DOEUVRE') ? 'PRESTATION' : src;
            document.getElementById('prev_rate').innerText = r.toString().replace('.', ',') + "%";
            document.getElementById('prev_ttc_label').innerHTML = isOccasion ? "Net Final (Exo TVA)" : "Net TTC (Fourn. + TVA)";
            document.getElementById('prev_ttc').innerText = formatMoney(finalVal);
            document.getElementById('preview_box').classList.remove('hidden');
        }

        function addOrUpdatePart() {
            const n = document.getElementById('part_name').value.trim() || "Désignation non précisée";
            const p = parseFloat(document.getElementById('part_price').value);
            const q = parseInt(document.getElementById('part_qty').value) || 1;
            if(!p) { return; }
            const type = document.getElementById('part_type').value;
            const src = (type === 'MAIN_DOEUVRE') ? 'PRESTATION' : document.querySelector('input[name="part_source"]:checked').value;
            const rate = getCalculatedRate();

            if (editingId !== null) {
                const idx = parts.findIndex(item => item.id === editingId);
                if (idx !== -1) parts[idx] = { ...parts[idx], name: n, type, qty: q, price: p, source: src, rate };
            } else {
                parts.push({ id: Date.now(), name: n, type, qty: q, price: p, source: src, rate });
            }
            renderTable();
            resetFormPart();
        }

        function editPart(id) {
            const item = parts.find(p => p.id === id);
            if (!item) return;
            editingId = id;
            document.getElementById('form_title').innerText = "Modifier l'article";
            document.getElementById('main_action_btn').innerText = "APPLIQUER MODIFICATION";
            document.getElementById('main_action_btn').classList.replace('bg-emerald-600', 'bg-indigo-600');
            document.getElementById('cancel_edit_btn').classList.remove('hidden');
            document.getElementById('piece_form_card').classList.add('ring-2', 'ring-indigo-100');
            
            document.getElementById('part_type').value = item.type;
            toggleFormContext();
            document.getElementById('part_name').value = item.name;
            document.getElementById('part_price').value = item.price;
            document.getElementById('part_qty').value = item.qty;
            
            if(item.type !== 'MAIN_DOEUVRE') {
                const sId = (item.source === 'ORIGINE') ? 'src_orig' : (item.source === 'ADAPTABLE' ? 'src_adapt' : 'src_recup');
                document.getElementById(sId).checked = true;
                handleSourceChange();
                let baseDisp = (item.source === 'ADAPTABLE') ? item.rate * 2 : item.rate;
                document.getElementById('manual_rate').value = baseDisp;
            }

            window.scrollTo({ top: document.getElementById('form_container').offsetTop - 20, behavior: 'smooth' });
            simulatePreview();
        }

        function resetFormPart() {
            editingId = null;
            document.getElementById('form_title').innerText = "Ajouter une pièce";
            document.getElementById('main_action_btn').innerText = "AJOUTER AU DOSSIER";
            document.getElementById('main_action_btn').classList.replace('bg-indigo-600', 'bg-emerald-600');
            document.getElementById('cancel_edit_btn').classList.add('hidden');
            document.getElementById('piece_form_card').classList.remove('ring-2', 'ring-indigo-100');
            document.getElementById('part_name').value = "";
            document.getElementById('part_price').value = "";
            document.getElementById('part_qty').value = "1";
            document.getElementById('manual_rate').value = "";
            document.getElementById('preview_box').classList.add('hidden');
        }

        function formatMoney(n) { return new Intl.NumberFormat('fr-MA', { minimumFractionDigits: 2 }).format(n); }

        function renderTable() {
            const tbody = document.getElementById('parts_table_body');
            const emptyMsg = document.getElementById('empty_msg');
            tbody.innerHTML = "";
            if(parts.length === 0) { emptyMsg.classList.remove('hidden'); updateTotalDisplay(0,0,0,0); return; }
            emptyMsg.classList.add('hidden');
            
            let tNetHT = 0, tTVA = 0, tVet = 0;
            const families = ["CARROSSERIE", "MECANIQUE", "USURE", "MAIN_DOEUVRE"];

            families.forEach(fam => {
                const famParts = parts.filter(p => p.type === fam);
                if (famParts.length > 0) {
                    const famLabel = fam === 'MAIN_DOEUVRE' ? "PRESTATION : MAIN D'ŒUVRE" : `FAMILLE : ${fam}`;
                    tbody.innerHTML += `
                        <tr class="bg-slate-100/80 border-y border-slate-200">
                            <td colspan="9" class="p-2 text-[10px] font-black text-indigo-700 uppercase tracking-widest">
                                <i class="fa-solid ${fam === 'MAIN_DOEUVRE' ? 'fa-wrench' : 'fa-folder-tree'} mr-2"></i> ${famLabel}
                            </td>
                        </tr>`;

                    let fNetHT = 0, fTTC = 0;

                    famParts.forEach(p => {
                        const b = p.price * p.qty, v = b * (p.rate / 100), nht = b - v;
                        const isOccasion = (p.source === 'RECUPERABLE' && p.type !== 'MAIN_DOEUVRE');
                        const rowTVA = isOccasion ? 0 : nht * 0.2;
                        const rowTotal = nht + rowTVA;
                        
                        tNetHT += nht; tTVA += rowTVA; tVet += v;
                        fNetHT += nht; fTTC += rowTotal;

                        const sColor = p.source === 'ORIGINE' ? 'bg-blue-100 text-blue-700' : 
                                       p.source === 'ADAPTABLE' ? 'bg-emerald-100 text-emerald-700' : 
                                       p.source === 'PRESTATION' ? 'bg-indigo-100 text-indigo-700' : 'bg-amber-100 text-amber-700';
                        
                        tbody.innerHTML += `
                            <tr class="hover:bg-white transition-all border-b border-slate-50">
                                <td class="p-4 font-bold text-slate-800">${p.name}</td>
                                <td class="p-4 text-center"><span class="px-2 py-0.5 rounded text-[9px] font-bold border ${sColor}">${p.source.slice(0,5)}</span></td>
                                <td class="p-4 text-center font-bold text-slate-600">${p.qty}</td>
                                <td class="p-4 text-center font-mono text-slate-400">${formatMoney(p.price)}</td>
                                <td class="p-4 text-center text-indigo-600 font-bold">${p.rate.toString().replace('.', ',')}%</td>
                                <td class="p-4 text-center font-mono text-rose-400">-${formatMoney(v)}</td>
                                <td class="p-4 text-center font-mono font-bold text-slate-900">${formatMoney(nht)}</td>
                                <td class="p-4 text-center font-mono font-bold text-indigo-600 bg-indigo-50/20">${formatMoney(rowTotal)}</td>
                                <td class="p-4 text-right">
                                    <div class="flex gap-2">
                                        <button onclick="editPart(${p.id})" class="text-emerald-600 p-1 hover:scale-110"><i class="fa-solid fa-pen-to-square"></i></button>
                                        <button onclick="parts = parts.filter(item => item.id !== ${p.id});renderTable()" class="text-rose-600 p-1 hover:scale-110"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </td>
                            </tr>`;
                    });

                    tbody.innerHTML += `
                        <tr class="bg-indigo-50/30 font-bold text-[10px]">
                            <td colspan="6" class="p-2 text-right text-slate-500 uppercase">Sous-total ${fam} :</td>
                            <td class="p-2 text-center font-mono text-slate-900 border-l border-white">${formatMoney(fNetHT)}</td>
                            <td class="p-2 text-center font-mono text-indigo-700 border-l border-white">${formatMoney(fTTC)}</td>
                            <td></td>
                        </tr>`;
                }
            });
            updateTotalDisplay(tNetHT, tTVA, tVet);
        }

        function updateTotalDisplay(netHT, tva, vet) {
            document.getElementById('sum_net_ht').innerText = formatMoney(netHT);
            document.getElementById('sum_vetuste').innerText = formatMoney(vet);
            document.getElementById('sum_net_ttc').innerText = formatMoney(netHT + tva);
        }

        // --- PDF ---
        function generatePDF(previewMode) {
            if(parts.length === 0) return;
            document.getElementById('pdf_date').innerText = new Date().toLocaleDateString('fr-FR');
            document.getElementById('pdf_ref').innerText = document.getElementById('ref_dossier').value || "S/R";
            document.getElementById('pdf_immat').innerText = document.getElementById('ref_immat').value || "S/I";
            document.getElementById('pdf_vehicle_name').innerText = (document.getElementById('veh_make').value + " " + document.getElementById('veh_model').value).trim() || "N/C";
            document.getElementById('pdf_mec').innerText = document.getElementById('date_mec').value || "--";
            document.getElementById('pdf_age').innerText = document.getElementById('display_age').innerText;
            document.getElementById('pdf_detailed_age').innerText = document.getElementById('detailed_duration').innerText;
            document.getElementById('pdf_cat').innerText = document.getElementById('cat_vehicule').value === 'A' ? "Tourisme" : "Utilitaire / PL";
            
            const pdfBody = document.getElementById('pdf_table_body');
            pdfBody.innerHTML = "";
            let tNetHT = 0, tTVA = 0, tVet = 0;
            const families = ["CARROSSERIE", "MECANIQUE", "USURE", "MAIN_DOEUVRE"];

            families.forEach(fam => {
                const famParts = parts.filter(p => p.type === fam);
                if(famParts.length > 0) {
                    pdfBody.innerHTML += `<tr style="background-color: #f8fafc;"><td colspan="7" style="padding: 6px; font-weight: 900; font-size: 8px; border-bottom: 1px solid #000; text-transform: uppercase;">FAMILLE : ${fam}</td></tr>`;
                    let fNetHT = 0, fTTC = 0;
                    famParts.forEach(p => {
                        const b = p.price * p.qty, v = b * (p.rate / 100), nht = b - v;
                        const isOccasion = (p.source === 'RECUPERABLE' && p.type !== 'MAIN_DOEUVRE');
                        const rowTVA = isOccasion ? 0 : nht * 0.2;
                        const rowTotal = nht + rowTVA;
                        tNetHT += nht; tTVA += rowTVA; tVet += v; fNetHT += nht; fTTC += rowTotal;

                        pdfBody.innerHTML += `<tr>
                            <td style="padding: 6px; border-bottom: 1px solid #eee;"><strong>${p.name}</strong><br><small style="color:#666">${p.source}</small></td>
                            <td style="padding: 6px; border-bottom: 1px solid #eee; text-align:center;">${p.qty}</td>
                            <td style="padding: 6px; border-bottom: 1px solid #eee; text-align:right;">${formatMoney(p.price)}</td>
                            <td style="padding: 6px; border-bottom: 1px solid #eee; text-align:center;">${p.rate}%</td>
                            <td style="padding: 6px; border-bottom: 1px solid #eee; text-align:right; color:#e11d48;">-${formatMoney(v)}</td>
                            <td style="padding: 6px; border-bottom: 1px solid #eee; text-align:right;">${formatMoney(nht)}</td>
                            <td style="padding: 6px; border-bottom: 1px solid #eee; text-align:right; font-weight:bold; color:#4f46e5;">${formatMoney(rowTotal)}</td>
                        </tr>`;
                    });
                    pdfBody.innerHTML += `<tr style="background-color: #f1f5f9; font-weight: bold; font-size: 7px;"><td colspan="5" style="padding: 5px; text-align: right;">SOUS-TOTAL ${fam} :</td><td style="padding: 5px; text-align: right;">${formatMoney(fNetHT)}</td><td style="padding: 5px; text-align: right; color:#4f46e5;">${formatMoney(fTTC)}</td></tr>`;
                }
            });
            
            document.getElementById('pdf_total_ht').innerText = formatMoney(tNetHT) + " DH";
            document.getElementById('pdf_tva').innerText = formatMoney(tTVA) + " DH";
            document.getElementById('pdf_total_vet').innerText = "-" + formatMoney(tVet) + " DH";
            document.getElementById('pdf_total_net_ttc').innerText = formatMoney(tNetHT + tTVA) + " DH";
            
            const element = document.getElementById('pdf-template');
            const opt = { margin: 5, filename: `BETCAM_Expertise_${document.getElementById('ref_dossier').value}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            if(previewMode) { html2pdf().from(element).set(opt).output('bloburl').then(url => window.open(url, '_blank')); } else { html2pdf().from(element).set(opt).save(); }
        }

        // --- UI HELPERS ---
        function resetSuggestions() { document.getElementById('part_name').value = ""; document.getElementById('custom_suggestions').classList.add('hidden'); updateMatrixUI(); }
        
        function showSuggestions() {
            const input = document.getElementById('part_name'), ul = document.getElementById('custom_suggestions');
            const type = document.getElementById('part_type').value;
            ul.innerHTML = "";
            const list = [...PARTS_DB[type]].sort((a, b) => a.localeCompare(b));
            list.forEach(m => {
                const li = document.createElement('li'); li.className="suggestion-item hover:bg-slate-50 transition-colors"; li.textContent=m;
                li.onclick = () => { input.value = m; ul.classList.add('hidden'); document.getElementById('part_price').focus(); simulatePreview(); };
                ul.appendChild(li);
            });
            ul.classList.remove('hidden');
        }

        function filterSuggestions() {
            const filter = document.getElementById('part_name').value.toUpperCase(), ul = document.getElementById('custom_suggestions');
            let count = 0;
            Array.from(ul.children).forEach(li => {
                const match = li.textContent.toUpperCase().includes(filter);
                li.style.display = match ? "" : "none";
                if(match) count++;
            });
            ul.classList.toggle('hidden', count === 0);
        }

        function resetApp() { if(confirm("Effacer tout le dossier ?")) location.reload(); }
        document.addEventListener('click', (e) => { if(!e.target.closest('#part_name') && !e.target.closest('#custom_suggestions')) document.getElementById('custom_suggestions').classList.add('hidden'); });
    </script>
</body>
</html>
