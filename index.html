<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BETCAM | Simulateur Vétusté Expert V2</title>
    
    <!-- Bibliothèques -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .input-field {
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
        }
        .input-field:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .category-badge {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 2px 8px;
            border-radius: 999px;
        }
        
        /* PDF specific hidden area */
        #pdf-template { display: none; }
        
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="text-slate-800 p-4 md:p-8 min-h-screen">

    <div class="max-w-6xl mx-auto space-y-6">
        
        <!-- HEADER -->
        <div class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-100 no-print">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-indigo-600 rounded-xl flex items-center justify-center text-white text-xl shadow-lg shadow-indigo-200">
                    <i class="fa-solid fa-layer-group"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-900">Simulateur Vétusté Expert</h1>
                    <p class="text-xs text-slate-500 uppercase tracking-wider font-medium">Cabinet BETCAM • Base de données pièces intégrée</p>
                </div>
            </div>
            <div class="mt-4 md:mt-0 flex gap-3">
                <button onclick="resetApp()" class="px-4 py-2 text-slate-500 hover:text-slate-700 text-sm font-medium transition-colors">
                    <i class="fa-solid fa-rotate-right mr-2"></i>Réinitialiser
                </button>
                <button onclick="generatePDF()" class="px-5 py-2 bg-slate-900 text-white rounded-lg text-sm font-medium hover:bg-slate-800 transition-all shadow-md">
                    <i class="fa-solid fa-file-export mr-2"></i>Export Rapport
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- LEFT COLUMN: CONFIGURATION -->
            <div class="lg:col-span-4 space-y-6 no-print">
                
                <!-- 1. VEHICLE CONTEXT -->
                <div class="glass-panel p-6 rounded-2xl">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-car"></i> Véhicule & Dates
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">Dossier / Immat</label>
                            <input type="text" id="ref_dossier" placeholder="Réf..." class="w-full p-2.5 rounded-lg bg-slate-50 input-field text-sm font-medium">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">M.E.C</label>
                                <input type="date" id="date_mec" class="w-full p-2.5 rounded-lg bg-slate-50 input-field text-sm" onchange="calcAge()">
                            </div>
                            <div>
                                <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">Sinistre</label>
                                <input type="date" id="date_sinistre" value="<?php echo date('Y-m-d'); ?>" class="w-full p-2.5 rounded-lg bg-slate-50 input-field text-sm" onchange="calcAge()">
                            </div>
                        </div>

                        <!-- Computed Age Display -->
                        <div class="bg-indigo-50 border border-indigo-100 p-3 rounded-lg flex items-center justify-between">
                            <span class="text-xs font-medium text-indigo-800">Année entamée</span>
                            <span id="display_age" class="text-sm font-bold text-indigo-600">--</span>
                            <input type="hidden" id="calculated_year" value="1">
                        </div>

                        <div>
                            <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">Catégorie (Tarif)</label>
                            <select id="cat_vehicule" class="w-full p-2.5 rounded-lg bg-slate-50 input-field text-sm font-medium" onchange="recalcAll()">
                                <option value="A">Tourisme / Non Utilitaire (Particulier)</option>
                                <option value="B">Utilitaire / Location / Poids Lourds</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 2. ADD PART FORM -->
                <div class="glass-panel p-6 rounded-2xl border-t-4 border-indigo-500">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-plus-circle"></i> Ajouter une pièce
                    </h2>
                    
                    <div class="space-y-4">
                        <!-- Famille Select FIRST to filter list -->
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">1. Famille</label>
                            <select id="part_type" class="w-full p-2.5 rounded-lg bg-white input-field text-sm font-medium" onchange="updatePartSuggestions()">
                                <option value="CARROSSERIE">Carrosserie</option>
                                <option value="MECANIQUE">Mécanique / Électrique</option>
                                <option value="USURE">Pièces d'Usure (Pneus, Freins...)</option>
                            </select>
                        </div>

                        <!-- Datalist Input -->
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">2. Libellé Pièce</label>
                            <input type="text" id="part_name" list="parts_list_suggestions" placeholder="Saisir ou sélectionner..." class="w-full p-2.5 rounded-lg bg-white input-field text-sm font-semibold text-slate-800" autocomplete="off">
                            <datalist id="parts_list_suggestions">
                                <!-- Suggestions injected via JS -->
                            </datalist>
                        </div>

                        <div>
                            <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">3. Prix Unitaire (TTC)</label>
                            <div class="relative">
                                <input type="number" id="part_price" placeholder="0.00" class="w-full p-2.5 rounded-lg bg-white input-field text-lg font-bold text-slate-800" onkeydown="handleEnter(event)">
                                <span class="absolute right-3 top-3 text-xs font-bold text-slate-400">DHS</span>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-lg border border-slate-100 cursor-pointer" onclick="document.getElementById('part_adapt').click()">
                            <input type="checkbox" id="part_adapt" class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                            <div>
                                <span class="text-xs font-bold text-slate-700 block">Pièce Adaptable</span>
                                <span class="text-[9px] text-slate-400 block">Réduction de 50% sur le taux</span>
                            </div>
                        </div>

                        <button onclick="addPart()" class="w-full py-3 bg-indigo-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:shadow-indigo-300 transition-all active:scale-95">
                            Ajouter la Ligne
                        </button>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: RESULTS -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- SUMMARY CARDS -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">Total Pièces</p>
                        <p id="sum_total" class="text-2xl font-bold text-slate-800 tracking-tight">0.00 <span class="text-xs font-normal text-slate-400">Dhs</span></p>
                    </div>
                    <div class="bg-rose-50 p-4 rounded-2xl border border-rose-100 shadow-sm">
                        <p class="text-[10px] uppercase font-bold text-rose-400 mb-1">Vétusté (À déduire)</p>
                        <p id="sum_vetuste" class="text-2xl font-bold text-rose-600 tracking-tight">0.00 <span class="text-xs font-normal text-rose-400">Dhs</span></p>
                    </div>
                    <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100 shadow-sm">
                        <p class="text-[10px] uppercase font-bold text-emerald-400 mb-1">Net à Payer (Assurance)</p>
                        <p id="sum_net" class="text-2xl font-bold text-emerald-600 tracking-tight">0.00 <span class="text-xs font-normal text-emerald-400">Dhs</span></p>
                    </div>
                </div>

                <!-- TABLE -->
                <div class="glass-panel rounded-2xl overflow-hidden min-h-[400px] flex flex-col">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Détail des Lignes</h3>
                        <span id="row_count" class="bg-slate-200 text-slate-600 text-[10px] font-bold px-2 py-1 rounded-md">0 lignes</span>
                    </div>
                    
                    <div class="overflow-x-auto flex-grow">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-[10px] font-bold text-slate-400 uppercase border-b border-slate-100 bg-white">
                                    <th class="p-4">Type</th>
                                    <th class="p-4">Libellé</th>
                                    <th class="p-4 text-right">Montant</th>
                                    <th class="p-4 text-center">Taux</th>
                                    <th class="p-4 text-right">Déduction</th>
                                    <th class="p-4 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="parts_table_body" class="text-sm font-medium text-slate-700 divide-y divide-slate-50 bg-white">
                                <!-- Rows will be injected here -->
                                <tr id="empty_state">
                                    <td colspan="6" class="p-12 text-center text-slate-400">
                                        <i class="fa-solid fa-basket-shopping text-3xl mb-3 opacity-20"></i>
                                        <p class="text-xs font-normal">Aucune pièce ajoutée.<br>Sélectionnez une famille pour voir les suggestions.</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center text-[10px] text-slate-400 font-medium uppercase tracking-widest mt-8 no-print">
            © BETCAM | Module Indépendant V.2.0
        </div>

    </div>

    <!-- PDF TEMPLATE (Hidden) -->
    <div id="pdf-template" class="bg-white text-black p-8 max-w-[210mm] mx-auto">
        <!-- Header PDF -->
        <div class="flex justify-between items-end border-b-2 border-black pb-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold uppercase tracking-tight">Cabinet BETCAM</h1>
                <p class="text-xs font-medium uppercase tracking-widest mt-1">État Détaillé de Vétusté</p>
            </div>
            <div class="text-right text-xs">
                <p>Date: <span id="pdf_date">--/--/----</span></p>
                <p>Réf: <span id="pdf_ref" class="font-bold">--</span></p>
            </div>
        </div>

        <!-- Info Dossier PDF -->
        <div class="bg-gray-50 p-4 rounded border border-gray-200 mb-6 text-sm">
            <div class="grid grid-cols-2 gap-4">
                <div><span class="font-bold">MEC :</span> <span id="pdf_mec">--</span></div>
                <div><span class="font-bold">Sinistre :</span> <span id="pdf_sinistre">--</span></div>
                <div><span class="font-bold">Catégorie :</span> <span id="pdf_cat">--</span></div>
                <div><span class="font-bold">Année appliquée :</span> <span id="pdf_age">--</span></div>
            </div>
        </div>

        <!-- Table PDF -->
        <table class="w-full text-xs border-collapse mb-8">
            <thead>
                <tr class="bg-gray-100 border-y border-black font-bold text-left uppercase">
                    <th class="p-2">Famille</th>
                    <th class="p-2">Désignation</th>
                    <th class="p-2 text-center">Origine</th>
                    <th class="p-2 text-right">Prix Unit.</th>
                    <th class="p-2 text-center">Taux</th>
                    <th class="p-2 text-right">Retenue</th>
                </tr>
            </thead>
            <tbody id="pdf_table_body" class="divide-y divide-gray-200">
                <!-- Content -->
            </tbody>
        </table>

        <!-- Totals PDF -->
        <div class="flex justify-end">
            <div class="w-1/2">
                <div class="flex justify-between py-2 border-b border-gray-300 text-sm">
                    <span>Total Pièces (TTC)</span>
                    <span id="pdf_total_brut" class="font-bold">0.00</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-300 text-sm">
                    <span>Total Vétusté</span>
                    <span id="pdf_total_vetuste" class="font-bold text-red-600">- 0.00</span>
                </div>
                <div class="flex justify-between py-3 border-b-2 border-black text-base font-bold bg-gray-50 px-2 mt-2">
                    <span>Net à Payer (Assurance)</span>
                    <span id="pdf_total_net">0.00 Dhs</span>
                </div>
            </div>
        </div>

        <div class="mt-12 text-[9px] text-center text-gray-500 uppercase">
            Document généré électroniquement • Algorithme conforme aux règles techniques.
        </div>
    </div>

    <script>
        // --- DATA: CATALOGUE PIECES ---
        const PARTS_DB = {
            CARROSSERIE: [
                "Pare-chocs Avant", "Pare-chocs Arrière", "Calandre", "Capot", "Coffre / Hayon",
                "Aile Avant Gauche", "Aile Avant Droite", "Aile Arrière Gauche", "Aile Arrière Droite",
                "Portière Avant Gauche", "Portière Avant Droite", "Portière Arrière Gauche", "Portière Arrière Droite",
                "Phare Avant Gauche", "Phare Avant Droit", "Feu Arrière Gauche", "Feu Arrière Droit", "Antibrouillard",
                "Rétroviseur Gauche", "Rétroviseur Droit", "Pare-brise", "Lunette Arrière", "Vitre Latérale",
                "Bas de Caisse", "Toit / Pavillon", "Traverse Avant", "Traverse Arrière", "Armature Pare-chocs",
                "Face Avant", "Passage de Roue", "Longeron", "Plancher"
            ],
            MECANIQUE: [
                "Radiateur Moteur", "Condenseur Clim", "Intercooler", "Ventilateur", "Compresseur Clim",
                "Alternateur", "Démarreur", "Batterie (Non Usure)", "Calculateur Moteur", "Faisceau Électrique",
                "Boîte de Vitesses", "Embrayage (Volant Moteur)", "Turbo", "Pompe à Injection", "Injecteurs",
                "Moteur Complet", "Culasse", "Carter Huile", "Pompe à Eau", "Pompe de Direction",
                "Crémaillère Direction", "Cardan Gauche", "Cardan Droit", "Triangle Suspension", "Berceau Moteur",
                "Amortisseur Avant", "Amortisseur Arrière", "Moyeu de Roue", "Train Arrière", "Échappement (Ligne)",
                "Catalyseur / FAP", "Sonde Lambda", "Débitmètre"
            ],
            USURE: [
                "Pneu Avant", "Pneu Arrière", "Jante (Si usée)", "Plaquettes de Frein AV", "Plaquettes de Frein AR",
                "Disques de Frein AV", "Disques de Frein AR", "Kit Distribution", "Courroie Accessoire",
                "Batterie (Standard)", "Bougies (Allumage/Préchauffage)", "Filtre à Huile", "Filtre à Air",
                "Filtre Carburant", "Filtre Habitacle", "Essuie-glaces", "Ampoules", "Liquide de Frein",
                "Liquide de Refroidissement", "Huile Moteur", "Silencieux Échappement (Usure)"
            ]
        };

        const MATRICES = {
            CARROSSERIE: { A: { rates: [0, 5, 10, 15, 20, 25], cap: 50 }, B: { rates: [10, 20, 30, 40, 50, 50], cap: 50 } },
            MECANIQUE: { A: { rates: [5, 10, 15, 20, 25, 30], cap: 60 }, B: { rates: [10, 20, 30, 40, 50, 50], cap: 60 } },
            USURE: { A: { rates: [15, 30, 45, 60], cap: 60 }, B: { rates: [25, 50, 70], cap: 70 } }
        };

        const LABELS = {
            CARROSSERIE: { label: "Carrosserie", color: "indigo" },
            MECANIQUE: { label: "Mécanique", color: "blue" },
            USURE: { label: "Pièce d'Usure", color: "orange" }
        };

        let parts = [];
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date_sinistre').value = today;
            calcAge();
            updatePartSuggestions(); // Initialize list
        });

        function handleEnter(e) {
            if(e.key === "Enter") addPart();
        }

        function updatePartSuggestions() {
            const type = document.getElementById('part_type').value;
            const dataList = document.getElementById('parts_list_suggestions');
            const inputName = document.getElementById('part_name');
            
            // Clear current list
            dataList.innerHTML = "";
            inputName.value = ""; // Clear input for convenience when switching types
            
            // Populate new list
            if (PARTS_DB[type]) {
                PARTS_DB[type].sort().forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    dataList.appendChild(option);
                });
            }
        }

        // --- CORE LOGIC ---

        function calcAge() {
            const mecStr = document.getElementById('date_mec').value;
            const sinStr = document.getElementById('date_sinistre').value;
            
            if (!mecStr || !sinStr) return;

            const mec = new Date(mecStr);
            const sin = new Date(sinStr);
            
            let months = (sin.getFullYear() - mec.getFullYear()) * 12;
            months -= mec.getMonth();
            months += sin.getMonth();
            
            if (sin.getDate() < mec.getDate()) months--;

            let yearStarted = Math.max(1, Math.floor(months / 12) + 1);

            document.getElementById('display_age').innerText = yearStarted + (yearStarted === 1 ? "ère année" : "ème année");
            document.getElementById('calculated_year').value = yearStarted;
            
            recalcAll();
        }

        function getRate(type, category, year, isAdaptable) {
            const matrix = MATRICES[type][category];
            let rate = 0;
            
            if (year <= matrix.rates.length) {
                rate = matrix.rates[year - 1];
            } else {
                rate = matrix.rates[matrix.rates.length - 1]; 
            }

            rate = Math.min(rate, matrix.cap);

            if (isAdaptable) {
                rate = rate * 0.5;
            }

            return rate;
        }

        function addPart() {
            const nameInput = document.getElementById('part_name');
            const name = nameInput.value.trim() || "Pièce diverse";
            const type = document.getElementById('part_type').value;
            const price = parseFloat(document.getElementById('part_price').value);
            const isAdapt = document.getElementById('part_adapt').checked;

            if (!price || price <= 0) {
                alert("Veuillez saisir un prix valide.");
                return;
            }

            const id = Date.now();
            parts.push({ id, name, type, price, isAdapt });
            
            nameInput.value = "";
            document.getElementById('part_price').value = "";
            document.getElementById('part_adapt').checked = false;
            nameInput.focus(); 

            renderTable();
        }

        function removePart(id) {
            parts = parts.filter(p => p.id !== id);
            renderTable();
        }

        function recalcAll() {
            renderTable();
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('fr-MA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount);
        }

        function renderTable() {
            const tbody = document.getElementById('parts_table_body');
            const cat = document.getElementById('cat_vehicule').value;
            const year = parseInt(document.getElementById('calculated_year').value) || 1;

            if (parts.length === 0) {
                tbody.innerHTML = `
                    <tr id="empty_state">
                        <td colspan="6" class="p-12 text-center text-slate-400">
                            <i class="fa-solid fa-basket-shopping text-3xl mb-3 opacity-20"></i>
                            <p class="text-xs font-normal">Aucune pièce ajoutée.<br>Sélectionnez une famille pour voir les suggestions.</p>
                        </td>
                    </tr>`;
                updateTotals(0, 0);
                document.getElementById('row_count').innerText = "0 lignes";
                return;
            }

            let html = "";
            let totalBrut = 0;
            let totalVetuste = 0;

            parts.forEach(part => {
                const rate = getRate(part.type, cat, year, part.isAdapt);
                const deduction = part.price * (rate / 100);
                
                totalBrut += part.price;
                totalVetuste += deduction;

                const style = LABELS[part.type];
                
                html += `
                    <tr class="hover:bg-slate-50 transition-colors group">
                        <td class="p-4">
                            <span class="category-badge bg-${style.color}-100 text-${style.color}-700 border border-${style.color}-200">
                                ${style.label}
                            </span>
                        </td>
                        <td class="p-4">
                            <div class="font-medium text-slate-900">${part.name}</div>
                            ${part.isAdapt ? '<span class="text-[10px] text-indigo-500 font-bold"><i class="fa-solid fa-check-circle mr-1"></i>Adaptable</span>' : ''}
                        </td>
                        <td class="p-4 text-right font-mono text-slate-600">${formatMoney(part.price)}</td>
                        <td class="p-4 text-center">
                            <span class="font-bold ${rate > 0 ? 'text-rose-500' : 'text-slate-400'}">${rate}%</span>
                        </td>
                        <td class="p-4 text-right font-mono font-bold text-rose-600">-${formatMoney(deduction)}</td>
                        <td class="p-4 text-center">
                            <button onclick="removePart(${part.id})" class="text-slate-300 hover:text-rose-500 transition-colors p-2">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
            document.getElementById('row_count').innerText = `${parts.length} ligne${parts.length > 1 ? 's' : ''}`;
            updateTotals(totalBrut, totalVetuste);
        }

        function updateTotals(brut, vetuste) {
            const net = brut - vetuste;
            document.getElementById('sum_total').innerHTML = `${formatMoney(brut)} <span class="text-xs font-normal text-slate-400">Dhs</span>`;
            document.getElementById('sum_vetuste').innerHTML = `${formatMoney(vetuste)} <span class="text-xs font-normal text-rose-400">Dhs</span>`;
            document.getElementById('sum_net').innerHTML = `${formatMoney(net)} <span class="text-xs font-normal text-emerald-400">Dhs</span>`;
        }

        function resetApp() {
            if(confirm("Tout effacer ?")) {
                parts = [];
                document.getElementById('ref_dossier').value = "";
                document.getElementById('part_name').value = "";
                document.getElementById('part_price').value = "";
                renderTable();
            }
        }

        // --- PDF EXPORT ---
        function generatePDF() {
            if (parts.length === 0) {
                alert("Ajoutez des pièces avant d'exporter.");
                return;
            }

            document.getElementById('pdf_date').innerText = new Date().toLocaleDateString('fr-FR');
            document.getElementById('pdf_ref').innerText = document.getElementById('ref_dossier').value || "N/A";
            
            const mec = document.getElementById('date_mec').value;
            const sin = document.getElementById('date_sinistre').value;
            document.getElementById('pdf_mec').innerText = mec ? new Date(mec).toLocaleDateString('fr-FR') : "--";
            document.getElementById('pdf_sinistre').innerText = sin ? new Date(sin).toLocaleDateString('fr-FR') : "--";
            
            const catVal = document.getElementById('cat_vehicule').value;
            document.getElementById('pdf_cat').innerText = catVal === "A" ? "Tourisme" : "Utilitaire/Lourd";
            document.getElementById('pdf_age').innerText = document.getElementById('display_age').innerText;

            const cat = document.getElementById('cat_vehicule').value;
            const year = parseInt(document.getElementById('calculated_year').value) || 1;
            let html = "";
            let totalBrut = 0;
            let totalVetuste = 0;

            parts.forEach(part => {
                const rate = getRate(part.type, cat, year, part.isAdapt);
                const deduction = part.price * (rate / 100);
                totalBrut += part.price;
                totalVetuste += deduction;

                html += `
                    <tr>
                        <td class="p-2 border-b border-gray-100">${LABELS[part.type].label}</td>
                        <td class="p-2 border-b border-gray-100 font-medium">${part.name}</td>
                        <td class="p-2 border-b border-gray-100 text-center text-[10px]">${part.isAdapt ? "ADAPTABLE" : "ORIGINE"}</td>
                        <td class="p-2 border-b border-gray-100 text-right">${formatMoney(part.price)}</td>
                        <td class="p-2 border-b border-gray-100 text-center">${rate}%</td>
                        <td class="p-2 border-b border-gray-100 text-right text-red-600">-${formatMoney(deduction)}</td>
                    </tr>
                `;
            });

            document.getElementById('pdf_table_body').innerHTML = html;
            document.getElementById('pdf_total_brut').innerText = formatMoney(totalBrut) + " Dhs";
            document.getElementById('pdf_total_vetuste').innerText = "-" + formatMoney(totalVetuste) + " Dhs";
            document.getElementById('pdf_total_net').innerText = formatMoney(totalBrut - totalVetuste) + " Dhs";

            const element = document.getElementById('pdf-template');
            element.style.display = 'block';

            const opt = {
                margin: 10,
                filename: `Vetuste_${document.getElementById('ref_dossier').value || 'Dossier'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                element.style.display = 'none';
            });
        }
    </script>
</body>
</html>
